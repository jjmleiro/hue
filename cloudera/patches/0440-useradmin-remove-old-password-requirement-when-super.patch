From 3b1e5271032fdc46a2500ff0ba337d1047e6cba6 Mon Sep 17 00:00:00 2001
From: krish <krish@cloudera.com>
Date: Mon, 12 Jan 2015 18:24:48 -0800
Subject: [PATCH 0440/1173] [useradmin] remove old password requirement when
 superuser tries to change password for another
 user

---
 .../src/useradmin/templates/edit_user.mako         |    2 +-
 apps/useradmin/src/useradmin/views.py              |    4 ++++
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/apps/useradmin/src/useradmin/templates/edit_user.mako b/apps/useradmin/src/useradmin/templates/edit_user.mako
index 2e149e9..f6cf977 100644
--- a/apps/useradmin/src/useradmin/templates/edit_user.mako
+++ b/apps/useradmin/src/useradmin/templates/edit_user.mako
@@ -62,7 +62,7 @@ ${ layout.menubar(section='users') }
             </div>
           % endif
           ${layout.render_field(form["password2"], extra_attrs=username is None and {'validate':'true'} or {})}
-          % if username:
+          % if username and "password_old" in form.fields:
             ${layout.render_field(form["password_old"], extra_attrs=username is None and {'validate':'true'} or {})}
           % endif
         % endif
diff --git a/apps/useradmin/src/useradmin/views.py b/apps/useradmin/src/useradmin/views.py
index 84a3f9e..cb33294 100644
--- a/apps/useradmin/src/useradmin/views.py
+++ b/apps/useradmin/src/useradmin/views.py
@@ -193,6 +193,8 @@ def edit_user(request, username=None):
 
   if request.method == 'POST':
     form = form_class(request.POST, instance=instance)
+    if request.user.is_superuser and request.user.username != username:
+      form.fields.pop("password_old")
     if form.is_valid(): # All validation rules pass
       if instance is None:
         instance = form.save()
@@ -238,6 +240,8 @@ def edit_user(request, username=None):
       'groups': default_user_group and [default_user_group] or []
     }
     form = form_class(instance=instance, initial=initial)
+    if request.user.is_superuser and request.user.username != username:
+      form.fields.pop("password_old")
 
   return render('edit_user.mako', request, dict(form=form, username=username))
 
-- 
1.7.9.5

