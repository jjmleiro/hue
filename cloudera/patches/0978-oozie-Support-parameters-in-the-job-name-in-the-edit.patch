From d3c34d8d354693dec9dfff5d0898a85b16f3c6d1 Mon Sep 17 00:00:00 2001
From: Romain Rigaux <romain@cloudera.com>
Date: Tue, 3 Mar 2015 14:01:17 -0800
Subject: [PATCH 0978/1173] [oozie] Support $ parameters in the job name in
 the editor

---
 apps/oozie/src/oozie/models2.py             |   22 ++++++++++++++++++++--
 desktop/libs/liboozie/src/liboozie/types.py |    2 +-
 2 files changed, 21 insertions(+), 3 deletions(-)

diff --git a/apps/oozie/src/oozie/models2.py b/apps/oozie/src/oozie/models2.py
index 71ad609..fd45e92 100644
--- a/apps/oozie/src/oozie/models2.py
+++ b/apps/oozie/src/oozie/models2.py
@@ -65,10 +65,10 @@ class Job(object):
 
     for c in self.name[:40]:
       if not good_name:
-        if not re.match('[a-zA-Z_]', c):
+        if not re.match('[a-zA-Z_\{\$\}]', c):
           c = '_'
       else:
-        if not re.match('[\-_a-zA-Z0-9]', c):
+        if not re.match('[\-_a-zA-Z0-9\{\$\}]', c):
           c = '_'
       good_name.append(c)
 
@@ -227,6 +227,9 @@ class Workflow(Job):
   def find_parameters(self):
     params = set()
 
+    for param in find_dollar_braced_variables(self.name):
+      params.add(param)
+
     if self.sla_enabled:
       for param in find_json_parameters(self.sla):
         params.add(param)
@@ -258,6 +261,10 @@ class Workflow(Job):
   def get_absolute_url(self):
     return reverse('oozie:edit_workflow') + '?workflow=%s' % self.id
 
+  @classmethod
+  def get_application_path_key(cls):
+    return 'oozie.wf.application.path'
+
 
 class Node():
   def __init__(self, data):
@@ -1625,6 +1632,9 @@ class Coordinator(Job):
   def find_parameters(self):
     params = set()
 
+    for param in find_dollar_braced_variables(self.name):
+      params.add(param)
+
     for param in find_json_parameters([self.data['properties']]):
       params.add(param)
 
@@ -1722,6 +1732,10 @@ class Coordinator(Job):
   def get_absolute_url(self):
     return reverse('oozie:edit_coordinator') + '?coordinator=%s' % self.id
 
+  @classmethod
+  def get_application_path_key(cls):
+    return 'oozie.coord.application.path'
+
 
 class Dataset():
 
@@ -1897,6 +1911,10 @@ class Bundle(Job):
   def find_parameters(self):
     return {}
 
+  @classmethod
+  def get_application_path_key(cls):
+    return 'oozie.bundle.application.path'
+
 
 class History(object):
 
diff --git a/desktop/libs/liboozie/src/liboozie/types.py b/desktop/libs/liboozie/src/liboozie/types.py
index de6365a..6622266 100644
--- a/desktop/libs/liboozie/src/liboozie/types.py
+++ b/desktop/libs/liboozie/src/liboozie/types.py
@@ -435,7 +435,7 @@ class Workflow(Job):
     return reverse('oozie:list_oozie_workflow', kwargs={'job_id': self.id}) + extra_params
 
   def get_progress(self, full_node_list=None):
-    if self.status == 'SUCCEEDED':
+    if self.status in ('SUCCEEDED', 'KILLED'):
       return 100 # Case of decision nodes
     else:
       if full_node_list is not None:            # Should remove the un-reached branches if decision node
-- 
1.7.9.5

