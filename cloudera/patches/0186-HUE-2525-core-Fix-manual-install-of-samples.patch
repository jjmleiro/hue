From fbed119b63c8346e3487ba9e15540752dfae9fa9 Mon Sep 17 00:00:00 2001
From: Romain Rigaux <romain@cloudera.com>
Date: Wed, 7 Jan 2015 09:35:33 -0800
Subject: [PATCH 0186/1173] HUE-2525 [core] Fix manual install of samples

---
 apps/about/src/about/views.py                      |    1 -
 .../commands/beeswax_install_examples.py           |   32 +++++++++++++-------
 apps/beeswax/src/beeswax/views.py                  |    2 +-
 apps/hbase/gen-py/__init__.py                      |   16 ++++++++++
 apps/hbase/src/hbase/__init__.py                   |    5 +++
 apps/hbase/src/hbase/management/__init__.py        |   15 +++++++++
 .../src/hbase/management/commands/__init__.py      |   16 ++++++++++
 apps/hbase/src/hbase/server/hbase_lib.py           |    4 +--
 8 files changed, 75 insertions(+), 16 deletions(-)

diff --git a/apps/about/src/about/views.py b/apps/about/src/about/views.py
index ed980f8..fea0eb8 100644
--- a/apps/about/src/about/views.py
+++ b/apps/about/src/about/views.py
@@ -15,7 +15,6 @@
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
-
 import json
 import logging
 
diff --git a/apps/beeswax/src/beeswax/management/commands/beeswax_install_examples.py b/apps/beeswax/src/beeswax/management/commands/beeswax_install_examples.py
index 3165ce0..59ce98d 100644
--- a/apps/beeswax/src/beeswax/management/commands/beeswax_install_examples.py
+++ b/apps/beeswax/src/beeswax/management/commands/beeswax_install_examples.py
@@ -17,23 +17,26 @@
 
 import logging
 import os
+import pwd
 import simplejson
 
-from django.core.management.base import NoArgsCommand
+from django.core.management.base import BaseCommand
 from django.contrib.auth.models import User
 from django.utils.translation import ugettext as _
 
-from desktop.models import Document
 from hadoop import cluster
 
+from desktop.lib.exceptions_renderable import PopupException
+from useradmin.models import install_sample_user
+from desktop.models import Document
+
 import beeswax.conf
 
 from beeswax.models import SavedQuery, IMPALA
 from beeswax.design import hql_query
 from beeswax.server import dbms
 from beeswax.server.dbms import get_query_server_config, QueryServerException
-from useradmin.models import install_sample_user
-from desktop.lib.exceptions_renderable import PopupException
+
 
 LOG = logging.getLogger(__name__)
 
@@ -42,18 +45,25 @@ class InstallException(Exception):
   pass
 
 
-class Command(NoArgsCommand):
-  """
-  Install examples but do not overwrite them.
-  """
-  def handle_noargs(self, **options):
+class Command(BaseCommand):
+  args = '<beeswax|impala>'
+  help = 'Install examples but do not overwrite them.'
+
+  def handle(self, *args, **options):
+    if args:
+      app_name = args[0]
+      user = User.objects.get(username=pwd.getpwuid(os.getuid()).pw_name)
+    else:
+      app_name = options['app_name']
+      user = options['user']
+
     exception = None
 
     # Documents will belong to this user but we run the install as the current user
     try:
       sample_user = install_sample_user()
-      self._install_queries(sample_user, options['app_name'])
-      self._install_tables(options['user'], options['app_name'])
+      self._install_queries(sample_user, app_name)
+      self._install_tables(user, app_name)
     except Exception, ex:
       exception = ex
 
diff --git a/apps/beeswax/src/beeswax/views.py b/apps/beeswax/src/beeswax/views.py
index ae487d3..22bfc25 100644
--- a/apps/beeswax/src/beeswax/views.py
+++ b/apps/beeswax/src/beeswax/views.py
@@ -568,7 +568,7 @@ def install_examples(request):
   if request.method == 'POST':
     try:
       app_name = get_app_name(request)
-      beeswax.management.commands.beeswax_install_examples.Command().handle_noargs(app_name=app_name, user=request.user)
+      beeswax.management.commands.beeswax_install_examples.Command().handle(app_name=app_name, user=request.user)
       response['status'] = 0
     except Exception, err:
       LOG.exception(err)
diff --git a/apps/hbase/gen-py/__init__.py b/apps/hbase/gen-py/__init__.py
index e69de29..d053ec4 100644
--- a/apps/hbase/gen-py/__init__.py
+++ b/apps/hbase/gen-py/__init__.py
@@ -0,0 +1,16 @@
+#!/usr/bin/env python
+# Licensed to Cloudera, Inc. under one
+# or more contributor license agreements.  See the NOTICE file
+# distributed with this work for additional information
+# regarding copyright ownership.  Cloudera, Inc. licenses this file
+# to you under the Apache License, Version 2.0 (the
+# "License"); you may not use this file except in compliance
+# with the License.  You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
diff --git a/apps/hbase/src/hbase/__init__.py b/apps/hbase/src/hbase/__init__.py
index 1854b36..b14ffc8 100644
--- a/apps/hbase/src/hbase/__init__.py
+++ b/apps/hbase/src/hbase/__init__.py
@@ -13,3 +13,8 @@
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
+
+import sys
+import os
+
+sys.path.append(os.path.join(os.path.dirname(__file__), '..', '..', 'gen-py'))
diff --git a/apps/hbase/src/hbase/management/__init__.py b/apps/hbase/src/hbase/management/__init__.py
index e69de29..1854b36 100644
--- a/apps/hbase/src/hbase/management/__init__.py
+++ b/apps/hbase/src/hbase/management/__init__.py
@@ -0,0 +1,15 @@
+# Licensed to Cloudera, Inc. under one
+# or more contributor license agreements.  See the NOTICE file
+# distributed with this work for additional information
+# regarding copyright ownership.  Cloudera, Inc. licenses this file
+# to you under the Apache License, Version 2.0 (the
+# "License"); you may not use this file except in compliance
+# with the License.  You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
diff --git a/apps/hbase/src/hbase/management/commands/__init__.py b/apps/hbase/src/hbase/management/commands/__init__.py
index e69de29..d053ec4 100644
--- a/apps/hbase/src/hbase/management/commands/__init__.py
+++ b/apps/hbase/src/hbase/management/commands/__init__.py
@@ -0,0 +1,16 @@
+#!/usr/bin/env python
+# Licensed to Cloudera, Inc. under one
+# or more contributor license agreements.  See the NOTICE file
+# distributed with this work for additional information
+# regarding copyright ownership.  Cloudera, Inc. licenses this file
+# to you under the Apache License, Version 2.0 (the
+# "License"); you may not use this file except in compliance
+# with the License.  You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
diff --git a/apps/hbase/src/hbase/server/hbase_lib.py b/apps/hbase/src/hbase/server/hbase_lib.py
index a2af2a7..15fd8bd 100644
--- a/apps/hbase/src/hbase/server/hbase_lib.py
+++ b/apps/hbase/src/hbase/server/hbase_lib.py
@@ -16,15 +16,13 @@
 # limitations under the License.
 
 import logging
-import sys,os
+import os
 
 from thrift import Thrift
 from thrift.transport.TSocket import TSocket
 from thrift.transport.TTransport import TBufferedTransport
 from thrift.protocol import TBinaryProtocol
 
-sys.path.append(os.path.join(os.path.dirname(__file__), '../../../gen-py'))
-
 from hbased import Hbase as thrift_hbase
 from hbased import ttypes
 
-- 
1.7.9.5

