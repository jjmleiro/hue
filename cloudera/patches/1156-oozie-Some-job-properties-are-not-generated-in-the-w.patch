From 830a8c2227189ada9a551afa55fae50f5c4008fa Mon Sep 17 00:00:00 2001
From: Romain Rigaux <romain@cloudera.com>
Date: Tue, 28 Apr 2015 07:15:21 -0700
Subject: [PATCH 1156/1173] [oozie] Some job properties are not generated in
 the workflow.xml

---
 .../templates/editor2/gen/workflow-hive.xml.mako   |    2 +-
 .../templates/editor2/gen/workflow-hive2.xml.mako  |    2 +-
 .../templates/editor2/gen/workflow-java.xml.mako   |    2 +-
 .../editor2/gen/workflow-mapreduce.xml.mako        |    2 +-
 .../templates/editor2/gen/workflow-shell.xml.mako  |    2 +-
 .../templates/editor2/gen/workflow-sqoop.xml.mako  |    2 +-
 .../editor2/gen/workflow-streaming.xml.mako        |    2 +-
 apps/oozie/src/oozie/tests2.py                     |   38 ++++++++++++++++----
 8 files changed, 39 insertions(+), 13 deletions(-)

diff --git a/apps/oozie/src/oozie/templates/editor2/gen/workflow-hive.xml.mako b/apps/oozie/src/oozie/templates/editor2/gen/workflow-hive.xml.mako
index f075692..c574cd1 100644
--- a/apps/oozie/src/oozie/templates/editor2/gen/workflow-hive.xml.mako
+++ b/apps/oozie/src/oozie/templates/editor2/gen/workflow-hive.xml.mako
@@ -26,7 +26,7 @@
             % if node['properties']['hive_xml']:
               <job-xml>${ node['properties']['hive_xml'] }</job-xml>
             % endif
-            ${ common.configuration(node['properties']['properties']) }
+            ${ common.configuration(node['properties']['job_properties']) }
 
             <script>${ node['properties']['script_path'] }</script>
 
diff --git a/apps/oozie/src/oozie/templates/editor2/gen/workflow-hive2.xml.mako b/apps/oozie/src/oozie/templates/editor2/gen/workflow-hive2.xml.mako
index 992b25a..8eae767 100644
--- a/apps/oozie/src/oozie/templates/editor2/gen/workflow-hive2.xml.mako
+++ b/apps/oozie/src/oozie/templates/editor2/gen/workflow-hive2.xml.mako
@@ -26,7 +26,7 @@
             % if node['properties']['job_xml']:
               <job-xml>${ node['properties']['job_xml'] }</job-xml>
             % endif
-            ${ common.configuration(node['properties']['properties']) }
+            ${ common.configuration(node['properties']['job_properties']) }
             
             <jdbc-url>${ node['properties']['jdbc_url'] }</jdbc-url>
             % if node['properties']['password']:
diff --git a/apps/oozie/src/oozie/templates/editor2/gen/workflow-java.xml.mako b/apps/oozie/src/oozie/templates/editor2/gen/workflow-java.xml.mako
index a373a8e..403a465 100644
--- a/apps/oozie/src/oozie/templates/editor2/gen/workflow-java.xml.mako
+++ b/apps/oozie/src/oozie/templates/editor2/gen/workflow-java.xml.mako
@@ -26,7 +26,7 @@
             % if node['properties']['job_xml']:
               <job-xml>${ node['properties']['job_xml'] }</job-xml>
             % endif
-            ${ common.configuration(node['properties']['properties']) }
+            ${ common.configuration(node['properties']['job_properties']) }
 
             <main-class>${ node['properties']['main_class'] }</main-class>
 
diff --git a/apps/oozie/src/oozie/templates/editor2/gen/workflow-mapreduce.xml.mako b/apps/oozie/src/oozie/templates/editor2/gen/workflow-mapreduce.xml.mako
index 8c85702..e84bcc3 100644
--- a/apps/oozie/src/oozie/templates/editor2/gen/workflow-mapreduce.xml.mako
+++ b/apps/oozie/src/oozie/templates/editor2/gen/workflow-mapreduce.xml.mako
@@ -26,7 +26,7 @@
             % if node['properties']['job_xml']:
               <job-xml>${ node['properties']['job_xml'] }</job-xml>
             % endif
-            ${ common.configuration(node['properties']['properties']) }
+            ${ common.configuration(node['properties']['job_properties']) }
 
             ${ common.distributed_cache(node['properties']['files'], node['properties']['archives']) }
         </map-reduce>
diff --git a/apps/oozie/src/oozie/templates/editor2/gen/workflow-shell.xml.mako b/apps/oozie/src/oozie/templates/editor2/gen/workflow-shell.xml.mako
index fb8a8c3..3e9ea11 100644
--- a/apps/oozie/src/oozie/templates/editor2/gen/workflow-shell.xml.mako
+++ b/apps/oozie/src/oozie/templates/editor2/gen/workflow-shell.xml.mako
@@ -26,7 +26,7 @@
             % if node['properties']['job_xml']:
               <job-xml>${ node['properties']['job_xml'] }</job-xml>
             % endif
-            ${ common.configuration(node['properties']['properties']) }
+            ${ common.configuration(node['properties']['job_properties']) }
 
             <exec>${ node['properties']['shell_command'] }</exec>
 
diff --git a/apps/oozie/src/oozie/templates/editor2/gen/workflow-sqoop.xml.mako b/apps/oozie/src/oozie/templates/editor2/gen/workflow-sqoop.xml.mako
index 068e78b..72ae2d4 100644
--- a/apps/oozie/src/oozie/templates/editor2/gen/workflow-sqoop.xml.mako
+++ b/apps/oozie/src/oozie/templates/editor2/gen/workflow-sqoop.xml.mako
@@ -26,7 +26,7 @@
             % if node['properties']['job_xml']:
               <job-xml>${ node['properties']['job_xml'] }</job-xml>
             % endif
-            ${ common.configuration(node['properties']['properties']) }
+            ${ common.configuration(node['properties']['job_properties']) }
 
             % if node['properties']['command']:
             <command>${ node['properties']['command'] }</command>
diff --git a/apps/oozie/src/oozie/templates/editor2/gen/workflow-streaming.xml.mako b/apps/oozie/src/oozie/templates/editor2/gen/workflow-streaming.xml.mako
index c59fcb1..1830a39 100644
--- a/apps/oozie/src/oozie/templates/editor2/gen/workflow-streaming.xml.mako
+++ b/apps/oozie/src/oozie/templates/editor2/gen/workflow-streaming.xml.mako
@@ -29,7 +29,7 @@
                 <reducer>${ node['properties']['reducer'] }</reducer>
                 % endif
             </streaming>
-            ${ common.configuration(node['properties']['properties']) }
+            ${ common.configuration(node['properties']['job_properties']) }
             ${ common.distributed_cache(node['properties']['files'], node['properties']['archives']) }
         </map-reduce>
         <ok to="${ node_mapping[node['children'][0]['to']].name }"/>
diff --git a/apps/oozie/src/oozie/tests2.py b/apps/oozie/src/oozie/tests2.py
index fe826c0..759163f 100644
--- a/apps/oozie/src/oozie/tests2.py
+++ b/apps/oozie/src/oozie/tests2.py
@@ -43,7 +43,7 @@ class TestEditor():
     assert_equal(['input', 'LIMIT', 'out'], find_dollar_variables("""
 data = '$input';
 $out = LIMIT data $LIMIT; -- ${nah}
-$output = STORE "$out";   
+$output = STORE "$out";
     """))
 
     assert_equal(['max_salary', 'limit'], find_dollar_variables("""
@@ -60,17 +60,43 @@ LIMIT $limit"""))
     assert_equal(['field', 'tablename', 'LIMIT'], find_dollar_braced_variables("""
     SELECT ${field}
     FROM ${hivevar:tablename}
-    LIMIT ${hiveconf:LIMIT}  
+    LIMIT ${hiveconf:LIMIT}
     """))
 
 
   def test_workflow_gen_xml(self):
     assert_equal([
-        u'<workflow-app', u'name="My_Workflow"', u'xmlns="uri:oozie:workflow:0.5">', u'<start', u'to="End"/>', u'<kill', u'name="Kill">', u'<message>Action', u'failed,', 
+        u'<workflow-app', u'name="My_Workflow"', u'xmlns="uri:oozie:workflow:0.5">', u'<start', u'to="End"/>', u'<kill', u'name="Kill">', u'<message>Action', u'failed,',
         u'error', u'message[${wf:errorMessage(wf:lastErrorNode())}]</message>', u'</kill>', u'<end', u'name="End"/>', u'</workflow-app>'],
         self.wf.to_xml({'output': '/path'}).split()
     )
 
+  def test_workflow_map_reduce_gen_xml(self):
+    wf = Workflow(data="{\"layout\": [{\"oozieRows\": [{\"enableOozieDropOnBefore\": true, \"enableOozieDropOnSide\": true, \"enableOozieDrop\": false, \"widgets\": [{\"status\": \"\", \"logsURL\": \"\", \"name\": \"MapReduce job\", \"widgetType\": \"mapreduce-widget\", \"oozieMovable\": true, \"ooziePropertiesExpanded\": false, \"properties\": {}, \"isLoading\": true, \"offset\": 0, \"actionURL\": \"\", \"progress\": 0, \"klass\": \"card card-widget span12\", \"oozieExpanded\": false, \"id\": \"0cf2d5d5-2315-0bda-bd53-0eec257e943f\", \"size\": 12}], \"id\": \"e2caca14-8afc-d7e0-287c-88accd0b4253\", \"columns\": []}], \"rows\": [{\"enableOozieDropOnBefore\": true, \"enableOozieDropOnSide\": true, \"enableOozieDrop\": false, \"widgets\": [{\"status\": \"\", \"logsURL\": \"\", \"name\": \"Start\", \"widgetType\": \"start-widget\", \"oozieMovable\": false, \"ooziePropertiesExpanded\": false, \"properties\": {}, \"isLoading\": true, \"offset\": 0, \"actionURL\": \"\", \"progress\": 0, \"klass\": \"card card-widget span12\", \"oozieExpanded\": false, \"id\": \"3f107997-04cc-8733-60a9-a4bb62cebffc\", \"size\": 12}], \"id\": \"ff63ee3f-df54-2fa3-477b-65f5e0f0632c\", \"columns\": []}, {\"enableOozieDropOnBefore\": true, \"enableOozieDropOnSide\": true, \"enableOozieDrop\": false, \"widgets\": [{\"status\": \"\", \"logsURL\": \"\", \"name\": \"MapReduce job\", \"widgetType\": \"mapreduce-widget\", \"oozieMovable\": true, \"ooziePropertiesExpanded\": false, \"properties\": {}, \"isLoading\": true, \"offset\": 0, \"actionURL\": \"\", \"progress\": 0, \"klass\": \"card card-widget span12\", \"oozieExpanded\": false, \"id\": \"0cf2d5d5-2315-0bda-bd53-0eec257e943f\", \"size\": 12}], \"id\": \"e2caca14-8afc-d7e0-287c-88accd0b4253\", \"columns\": []}, {\"enableOozieDropOnBefore\": true, \"enableOozieDropOnSide\": true, \"enableOozieDrop\": false, \"widgets\": [{\"status\": \"\", \"logsURL\": \"\", \"name\": \"End\", \"widgetType\": \"end-widget\", \"oozieMovable\": false, \"ooziePropertiesExpanded\": false, \"properties\": {}, \"isLoading\": true, \"offset\": 0, \"actionURL\": \"\", \"progress\": 0, \"klass\": \"card card-widget span12\", \"oozieExpanded\": false, \"id\": \"33430f0f-ebfa-c3ec-f237-3e77efa03d0a\", \"size\": 12}], \"id\": \"6a13d869-d04c-8431-6c5c-dbe67ea33889\", \"columns\": []}, {\"enableOozieDropOnBefore\": true, \"enableOozieDropOnSide\": true, \"enableOozieDrop\": false, \"widgets\": [{\"status\": \"\", \"logsURL\": \"\", \"name\": \"Kill\", \"widgetType\": \"kill-widget\", \"oozieMovable\": true, \"ooziePropertiesExpanded\": false, \"properties\": {}, \"isLoading\": true, \"offset\": 0, \"actionURL\": \"\", \"progress\": 0, \"klass\": \"card card-widget span12\", \"oozieExpanded\": false, \"id\": \"17c9c895-5a16-7443-bb81-f34b30b21548\", \"size\": 12}], \"id\": \"e3b56553-7a4f-43d2-b1e2-4dc433280095\", \"columns\": []}], \"oozieEndRow\": {\"enableOozieDropOnBefore\": true, \"enableOozieDropOnSide\": true, \"enableOozieDrop\": false, \"widgets\": [{\"status\": \"\", \"logsURL\": \"\", \"name\": \"End\", \"widgetType\": \"end-widget\", \"oozieMovable\": false, \"ooziePropertiesExpanded\": false, \"properties\": {}, \"isLoading\": true, \"offset\": 0, \"actionURL\": \"\", \"progress\": 0, \"klass\": \"card card-widget span12\", \"oozieExpanded\": false, \"id\": \"33430f0f-ebfa-c3ec-f237-3e77efa03d0a\", \"size\": 12}], \"id\": \"6a13d869-d04c-8431-6c5c-dbe67ea33889\", \"columns\": []}, \"oozieKillRow\": {\"enableOozieDropOnBefore\": true, \"enableOozieDropOnSide\": true, \"enableOozieDrop\": false, \"widgets\": [{\"status\": \"\", \"logsURL\": \"\", \"name\": \"Kill\", \"widgetType\": \"kill-widget\", \"oozieMovable\": true, \"ooziePropertiesExpanded\": false, \"properties\": {}, \"isLoading\": true, \"offset\": 0, \"actionURL\": \"\", \"progress\": 0, \"klass\": \"card card-widget span12\", \"oozieExpanded\": false, \"id\": \"17c9c895-5a16-7443-bb81-f34b30b21548\", \"size\": 12}], \"id\": \"e3b56553-7a4f-43d2-b1e2-4dc433280095\", \"columns\": []}, \"enableOozieDropOnAfter\": true, \"oozieStartRow\": {\"enableOozieDropOnBefore\": true, \"enableOozieDropOnSide\": true, \"enableOozieDrop\": false, \"widgets\": [{\"status\": \"\", \"logsURL\": \"\", \"name\": \"Start\", \"widgetType\": \"start-widget\", \"oozieMovable\": false, \"ooziePropertiesExpanded\": false, \"properties\": {}, \"isLoading\": true, \"offset\": 0, \"actionURL\": \"\", \"progress\": 0, \"klass\": \"card card-widget span12\", \"oozieExpanded\": false, \"id\": \"3f107997-04cc-8733-60a9-a4bb62cebffc\", \"size\": 12}], \"id\": \"ff63ee3f-df54-2fa3-477b-65f5e0f0632c\", \"columns\": []}, \"klass\": \"card card-home card-column span12\", \"enableOozieDropOnBefore\": true, \"drops\": [\"temp\"], \"id\": \"0c1908e7-0096-46e7-a16b-b17b1142a730\", \"size\": 12}], \"workflow\": {\"properties\": {\"job_xml\": \"\", \"description\": \"\", \"wf1_id\": null, \"sla_enabled\": false, \"deployment_dir\": \"/user/hue/oozie/workspaces/hue-oozie-1430228904.58\", \"schema_version\": \"uri:oozie:workflow:0.5\", \"sla\": [{\"key\": \"enabled\", \"value\": false}, {\"key\": \"nominal-time\", \"value\": \"${nominal_time}\"}, {\"key\": \"should-start\", \"value\": \"\"}, {\"key\": \"should-end\", \"value\": \"${30 * MINUTES}\"}, {\"key\": \"max-duration\", \"value\": \"\"}, {\"key\": \"alert-events\", \"value\": \"\"}, {\"key\": \"alert-contact\", \"value\": \"\"}, {\"key\": \"notification-msg\", \"value\": \"\"}, {\"key\": \"upstream-apps\", \"value\": \"\"}], \"show_arrows\": true, \"parameters\": [{\"name\": \"oozie.use.system.libpath\", \"value\": true}], \"properties\": []}, \"name\": \"My Workflow\", \"versions\": [\"uri:oozie:workflow:0.4\", \"uri:oozie:workflow:0.4.5\", \"uri:oozie:workflow:0.5\"], \"isDirty\": true, \"movedNode\": null, \"linkMapping\": {\"0cf2d5d5-2315-0bda-bd53-0eec257e943f\": [\"33430f0f-ebfa-c3ec-f237-3e77efa03d0a\"], \"33430f0f-ebfa-c3ec-f237-3e77efa03d0a\": [], \"3f107997-04cc-8733-60a9-a4bb62cebffc\": [\"0cf2d5d5-2315-0bda-bd53-0eec257e943f\"], \"17c9c895-5a16-7443-bb81-f34b30b21548\": []}, \"nodeIds\": [\"3f107997-04cc-8733-60a9-a4bb62cebffc\", \"33430f0f-ebfa-c3ec-f237-3e77efa03d0a\", \"17c9c895-5a16-7443-bb81-f34b30b21548\", \"0cf2d5d5-2315-0bda-bd53-0eec257e943f\"], \"nodes\": [{\"properties\": {}, \"name\": \"Start\", \"children\": [{\"to\": \"0cf2d5d5-2315-0bda-bd53-0eec257e943f\"}], \"actionParametersFetched\": false, \"type\": \"start-widget\", \"id\": \"3f107997-04cc-8733-60a9-a4bb62cebffc\", \"actionParameters\": []}, {\"properties\": {}, \"name\": \"End\", \"children\": [], \"actionParametersFetched\": false, \"type\": \"end-widget\", \"id\": \"33430f0f-ebfa-c3ec-f237-3e77efa03d0a\", \"actionParameters\": []}, {\"properties\": {\"message\": \"Action failed, error message[${wf:errorMessage(wf:lastErrorNode())}]\"}, \"name\": \"Kill\", \"children\": [], \"actionParametersFetched\": false, \"type\": \"kill-widget\", \"id\": \"17c9c895-5a16-7443-bb81-f34b30b21548\", \"actionParameters\": []}, {\"properties\": {\"files\": [], \"job_xml\": \"\", \"jar_path\": \"my_jar\", \"job_properties\": [{\"name\": \"prop_1_name\", \"value\": \"prop_1_value\"}], \"archives\": [], \"prepares\": [], \"credentials\": [], \"sla\": [{\"key\": \"enabled\", \"value\": false}, {\"key\": \"nominal-time\", \"value\": \"${nominal_time}\"}, {\"key\": \"should-start\", \"value\": \"\"}, {\"key\": \"should-end\", \"value\": \"${30 * MINUTES}\"}, {\"key\": \"max-duration\", \"value\": \"\"}, {\"key\": \"alert-events\", \"value\": \"\"}, {\"key\": \"alert-contact\", \"value\": \"\"}, {\"key\": \"notification-msg\", \"value\": \"\"}, {\"key\": \"upstream-apps\", \"value\": \"\"}]}, \"name\": \"mapreduce-0cf2\", \"children\": [{\"to\": \"33430f0f-ebfa-c3ec-f237-3e77efa03d0a\"}, {\"error\": \"17c9c895-5a16-7443-bb81-f34b30b21548\"}], \"actionParametersFetched\": false, \"type\": \"mapreduce-widget\", \"id\": \"0cf2d5d5-2315-0bda-bd53-0eec257e943f\", \"actionParameters\": []}], \"id\": 50019, \"nodeNamesMapping\": {\"0cf2d5d5-2315-0bda-bd53-0eec257e943f\": \"mapreduce-0cf2\", \"33430f0f-ebfa-c3ec-f237-3e77efa03d0a\": \"End\", \"3f107997-04cc-8733-60a9-a4bb62cebffc\": \"Start\", \"17c9c895-5a16-7443-bb81-f34b30b21548\": \"Kill\"}, \"uuid\": \"084f4d4c-00f1-62d2-e27e-e153c1f9acfb\"}}")
+
+    assert_equal([
+        u'<workflow-app', u'name="My_Workflow"', u'xmlns="uri:oozie:workflow:0.5">',
+        u'<start', u'to="mapreduce-0cf2"/>',
+        u'<kill', u'name="Kill">', u'<message>Action', u'failed,', u'error', u'message[${wf:errorMessage(wf:lastErrorNode())}]</message>', u'</kill>',
+        u'<action', u'name="mapreduce-0cf2">',
+        u'<map-reduce>',
+        u'<job-tracker>${jobTracker}</job-tracker>',
+        u'<name-node>${nameNode}</name-node>',
+        u'<configuration>',
+        u'<property>',
+        u'<name>prop_1_name</name>',
+        u'<value>prop_1_value</value>',
+        u'</property>',
+        u'</configuration>',
+        u'</map-reduce>',
+        u'<ok', u'to="End"/>',
+        u'<error', u'to="Kill"/>',
+        u'</action>',
+        u'<end', u'name="End"/>',
+        u'</workflow-app>'
+        ],
+        wf.to_xml({'output': '/path'}).split()
+    )
 
   def test_job_validate_xml_name(self):
     job = Workflow()
@@ -80,13 +106,13 @@ LIMIT $limit"""))
 
     job.update_name('aa')
     assert_equal('aa', job.validated_name)
-    
+
     job.update_name('%a')
     assert_equal('_a', job.validated_name)
-    
+
     job.update_name('aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaz')
     assert_equal(len('aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa'), len(job.validated_name))
-    
+
     job.update_name('My <...> 1st W$rkflow [With] (Bad) letter$')
     assert_equal('My_______1st_W$rkflow__With___Bad__lette', job.validated_name)
 
-- 
1.7.9.5

