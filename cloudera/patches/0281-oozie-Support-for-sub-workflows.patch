From 0cbcdc3bf092a539014b89d5b34cae8cdef02e62 Mon Sep 17 00:00:00 2001
From: Romain Rigaux <romain@cloudera.com>
Date: Wed, 12 Nov 2014 06:56:58 -0800
Subject: [PATCH 0281/1173] [oozie] Support for sub workflows

---
 apps/oozie/src/oozie/models2.py                    |   48 ++++++++++++++++++--
 .../templates/editor/gen2/workflow-fork.xml.mako   |    2 +-
 .../templates/editor/gen2/workflow-hive.xml.mako   |    4 +-
 .../templates/editor/gen2/workflow-java.xml.mako   |    4 +-
 .../templates/editor/gen2/workflow-join.xml.mako   |    2 +-
 .../templates/editor/gen2/workflow-pig.xml.mako    |    4 +-
 .../templates/editor/gen2/workflow-start.xml.mako  |    2 +-
 .../editor/gen2/workflow-subworkflow.xml.mako      |   12 ++---
 .../oozie/templates/editor/gen2/workflow.xml.mako  |    2 +-
 .../oozie/templates/editor/workflow_editor.mako    |    6 ++-
 apps/oozie/src/oozie/views/editor2.py              |   18 ++++----
 desktop/libs/liboozie/src/liboozie/submission2.py  |    8 ++--
 12 files changed, 77 insertions(+), 35 deletions(-)

diff --git a/apps/oozie/src/oozie/models2.py b/apps/oozie/src/oozie/models2.py
index ff7825f..000bded 100644
--- a/apps/oozie/src/oozie/models2.py
+++ b/apps/oozie/src/oozie/models2.py
@@ -153,13 +153,17 @@ class Workflow():
 
     data = self.get_data()
     nodes = [Node(node) for node in data['workflow']['nodes']]
-    node_mapping = dict([(node.id, node.name) for node in nodes])
+    node_mapping = dict([(node.id, node) for node in nodes])
+    
+    sub_wfs_ids = [node.data['properties']['workflow'] for node in nodes if node.data['type'] == 'subworkflow']
+    workflow_mapping = dict([(workflow.uuid, Workflow(document=workflow)) for workflow in Document2.objects.filter(uuid__in=sub_wfs_ids)])
 
     xml = re.sub(re.compile('\s*\n+', re.MULTILINE), '\n', django_mako.render_to_string(tmpl, {
               'workflow': data['workflow'],
               'nodes': nodes,
               'mapping': mapping,
-              'node_mapping': node_mapping
+              'node_mapping': node_mapping,
+              'workflow_mapping': workflow_mapping
           }))
     return force_unicode(xml)  
 
@@ -205,16 +209,19 @@ class Node():
     
     self._augment_data()
     
-  def to_xml(self, mapping=None, node_mapping=None):
+  def to_xml(self, mapping=None, node_mapping=None, workflow_mapping=None):
     if mapping is None:
       mapping = {}
     if node_mapping is None:
       node_mapping = {}
+    if workflow_mapping is None:
+      workflow_mapping = {}
 
     data = {
       'node': self.data,
       'mapping': mapping,
-      'node_mapping': node_mapping
+      'node_mapping': node_mapping,
+      'workflow_mapping': workflow_mapping
     }
 
     return django_mako.render_to_string(self.get_template_name(), data)
@@ -463,6 +470,38 @@ class HiveAction():
     return [cls.FIELDS['script_path']]
 
 
+class SubWorkflowAction():
+  TYPE = 'subworkflow'
+  FIELDS = {
+     'workflow': { 
+          'name': 'workflow',
+          'label': _('Sub-workflow'),
+          'value': None,
+          'help_text': _('The sub-workflow application to include. You must own all the sub-workflows')
+     },
+     'propagate_configuration': { 
+          'name': 'propagate_configuration',
+          'label': _('Propagate configuration'),
+          'value': True,
+          'help_text': _('If the workflow job configuration should be propagated to the child workflow.')
+     },
+     'job_properties': { 
+          'name': 'job_properties',
+          'label': _('Hadoop job properties'),
+          'value': [],
+          'help_text': _('Can be used to specify the job properties that are required to run the child workflow job.')
+     }
+  }
+
+  @classmethod
+  def get_fields(cls):
+    return [(f['name'], f['value']) for f in cls.FIELDS.itervalues()]
+  
+  @classmethod
+  def get_mandatory_fields(cls):
+    return []
+
+
 class KillAction():
   TYPE = 'kill'
   FIELDS = {
@@ -487,6 +526,7 @@ NODES = {
   'pig-widget': PigAction,
   'java-widget': JavaAction,
   'hive-widget': HiveAction,
+  'subworkflow-widget': SubWorkflowAction,
   'kill-widget': KillAction
 }
 
diff --git a/apps/oozie/src/oozie/templates/editor/gen2/workflow-fork.xml.mako b/apps/oozie/src/oozie/templates/editor/gen2/workflow-fork.xml.mako
index e329e72..459e60c 100644
--- a/apps/oozie/src/oozie/templates/editor/gen2/workflow-fork.xml.mako
+++ b/apps/oozie/src/oozie/templates/editor/gen2/workflow-fork.xml.mako
@@ -17,6 +17,6 @@
 
     <fork name="${ node['name'] }">
         % for child in node['children']:
-        <path start="${ node_mapping[child['to']] }" />
+        <path start="${ node_mapping[child['to']].name }" />
         % endfor
     </fork>
diff --git a/apps/oozie/src/oozie/templates/editor/gen2/workflow-hive.xml.mako b/apps/oozie/src/oozie/templates/editor/gen2/workflow-hive.xml.mako
index 733b40a..de0e417 100644
--- a/apps/oozie/src/oozie/templates/editor/gen2/workflow-hive.xml.mako
+++ b/apps/oozie/src/oozie/templates/editor/gen2/workflow-hive.xml.mako
@@ -36,7 +36,7 @@
 
             ${ common.distributed_cache(node['properties']['files'], node['properties']['archives']) }
         </hive>
-        <ok to="${ node_mapping[node['children'][0]['to']] }"/>
-        <error to="${ node_mapping[node['children'][1]['error']] }"/>
+        <ok to="${ node_mapping[node['children'][0]['to']].name }"/>
+        <error to="${ node_mapping[node['children'][1]['error']].name }"/>
         ${ common.sla(node) }
     </action>
diff --git a/apps/oozie/src/oozie/templates/editor/gen2/workflow-java.xml.mako b/apps/oozie/src/oozie/templates/editor/gen2/workflow-java.xml.mako
index 36e90dd..a373a8e 100644
--- a/apps/oozie/src/oozie/templates/editor/gen2/workflow-java.xml.mako
+++ b/apps/oozie/src/oozie/templates/editor/gen2/workflow-java.xml.mako
@@ -44,7 +44,7 @@
             <capture-output/>
             % endif
         </java>
-        <ok to="${ node_mapping[node['children'][0]['to']] }"/>
-        <error to="${ node_mapping[node['children'][1]['error']] }"/>
+        <ok to="${ node_mapping[node['children'][0]['to']].name }"/>
+        <error to="${ node_mapping[node['children'][1]['error']].name }"/>
         ${ common.sla(node) }
     </action>
diff --git a/apps/oozie/src/oozie/templates/editor/gen2/workflow-join.xml.mako b/apps/oozie/src/oozie/templates/editor/gen2/workflow-join.xml.mako
index 833bb19..2dc6a11 100644
--- a/apps/oozie/src/oozie/templates/editor/gen2/workflow-join.xml.mako
+++ b/apps/oozie/src/oozie/templates/editor/gen2/workflow-join.xml.mako
@@ -15,4 +15,4 @@
 ## See the License for the specific language governing permissions and
 ## limitations under the License.
 
-    <join name="${ node['name'] }" to="${ node_mapping[node['children'][0]['to']] }"/>
+    <join name="${ node['name'] }" to="${ node_mapping[node['children'][0]['to']].name }"/>
diff --git a/apps/oozie/src/oozie/templates/editor/gen2/workflow-pig.xml.mako b/apps/oozie/src/oozie/templates/editor/gen2/workflow-pig.xml.mako
index a891164..bf0078a 100644
--- a/apps/oozie/src/oozie/templates/editor/gen2/workflow-pig.xml.mako
+++ b/apps/oozie/src/oozie/templates/editor/gen2/workflow-pig.xml.mako
@@ -39,7 +39,7 @@
 
             ${ common.distributed_cache(node['properties']['files'], node['properties']['archives']) }
         </pig>
-        <ok to="${ node_mapping[node['children'][0]['to']] }"/>
-        <error to="${ node_mapping[node['children'][1]['error']] }"/>
+        <ok to="${ node_mapping[node['children'][0]['to']].name }"/>
+        <error to="${ node_mapping[node['children'][1]['error']].name }"/>
         ${ common.sla(node) }
     </action>
diff --git a/apps/oozie/src/oozie/templates/editor/gen2/workflow-start.xml.mako b/apps/oozie/src/oozie/templates/editor/gen2/workflow-start.xml.mako
index c5f0a3e..3a7852c 100644
--- a/apps/oozie/src/oozie/templates/editor/gen2/workflow-start.xml.mako
+++ b/apps/oozie/src/oozie/templates/editor/gen2/workflow-start.xml.mako
@@ -15,4 +15,4 @@
 ## See the License for the specific language governing permissions and
 ## limitations under the License.
 
-    <start to="${ node_mapping[node['children'][0]['to']] }"/>
+    <start to="${ node_mapping[node['children'][0]['to']].name }"/>
diff --git a/apps/oozie/src/oozie/templates/editor/gen2/workflow-subworkflow.xml.mako b/apps/oozie/src/oozie/templates/editor/gen2/workflow-subworkflow.xml.mako
index 6d81173..e20a4ce 100644
--- a/apps/oozie/src/oozie/templates/editor/gen2/workflow-subworkflow.xml.mako
+++ b/apps/oozie/src/oozie/templates/editor/gen2/workflow-subworkflow.xml.mako
@@ -17,17 +17,17 @@
 
 <%namespace name="common" file="workflow-common.xml.mako" />
 
-    <action name="${ node }"${ common.credentials(node.credentials) }>
+    <action name="${ node['name'] }"${ common.credentials(node['properties']['credentials']) }>
         <sub-workflow>
-            <app-path>${'${'}nameNode}${ node.sub_workflow.deployment_dir }</app-path>
+            <app-path>${'${'}nameNode}${ workflow_mapping[node['properties']['workflow']].deployment_dir }</app-path>
 
-            % if node.propagate_configuration:
+            % if node['properties']['propagate_configuration']:
               <propagate-configuration/>
             % endif
 
-            ${ common.configuration(node.get_properties()) }
+            ${ common.configuration(node['properties']['job_properties']) }
         </sub-workflow>
-        <ok to="${ node.get_oozie_child('ok') }"/>
-        <error to="${ node.get_oozie_child('error') }"/>
+        <ok to="${ node_mapping[node['children'][0]['to']].name }"/>
+        <error to="${ node_mapping[node['children'][1]['error']].name }"/>
         ${ common.sla(node) }
     </action>
diff --git a/apps/oozie/src/oozie/templates/editor/gen2/workflow.xml.mako b/apps/oozie/src/oozie/templates/editor/gen2/workflow.xml.mako
index 16af4b4..3e3a324 100644
--- a/apps/oozie/src/oozie/templates/editor/gen2/workflow.xml.mako
+++ b/apps/oozie/src/oozie/templates/editor/gen2/workflow.xml.mako
@@ -47,7 +47,7 @@
   </credentials>
   % endif
   % for node in nodes:
-      ${ node.to_xml(mapping, node_mapping) | n }
+      ${ node.to_xml(mapping, node_mapping, workflow_mapping) | n }
   % endfor
   ${ common.sla(workflow) }
 </workflow-app>
diff --git a/apps/oozie/src/oozie/templates/editor/workflow_editor.mako b/apps/oozie/src/oozie/templates/editor/workflow_editor.mako
index eb4048e..6470c3e 100644
--- a/apps/oozie/src/oozie/templates/editor/workflow_editor.mako
+++ b/apps/oozie/src/oozie/templates/editor/workflow_editor.mako
@@ -72,7 +72,7 @@ ${ commonheader(_("Workflow Editor"), "Oozie", user) | n,unicode }
 
     <div data-bind="css: { 'draggable-widget': true },
                     draggable: {data: draggableSubworkflowAction(), isEnabled: true,
-                    options: {'start': function(event, ui){}}}"
+                    options: {'start': function(event, ui){$root.setCurrentDraggedWidget(draggableSubworkflowAction());}}}"
          title="${_('Sub workflow')}" rel="tooltip" data-placement="top">
          <a class="draggable-icon"><i class="fa fa-code-fork"></i></a>
     </div>
@@ -707,7 +707,9 @@ ${ commonheader(_("Workflow Editor"), "Oozie", user) | n,unicode }
       </ul>
       <div class="tab-content">
         <div class="tab-pane active" id="action">
-          <input type="text" data-bind="value: properties.subworkflow" />
+          <span data-bind="text: $root.workflow_properties.workflow.label"></span>
+          <input type="text" data-bind="value: properties.workflow" />
+          <select data-bind="options: $root.addActionWorkflows, optionsText: 'name', value: properties.selectedSubWorkflow"></select>
         </div>
         <div class="tab-pane" id="properties">
           <span data-bind="template: { name: 'common-action-properties' }"></span>
diff --git a/apps/oozie/src/oozie/views/editor2.py b/apps/oozie/src/oozie/views/editor2.py
index ac15277..fed6202 100644
--- a/apps/oozie/src/oozie/views/editor2.py
+++ b/apps/oozie/src/oozie/views/editor2.py
@@ -113,14 +113,6 @@ def save_workflow(request):
 
   return HttpResponse(json.dumps(response), mimetype="application/json")
 
-#  elif node['widgetType'] == 'subworkflow-widget':
-#    workflows = [{
-#        'name': workflow.name,
-#        'owner': workflow.owner.username,
-#        'value': workflow.uuid
-#      } for workflow in Document2.objects.filter(type='oozie-workflow2', owner=request.user)
-#    ]
-
 
 def new_node(request):
   response = {'status': -1}
@@ -130,6 +122,14 @@ def new_node(request):
 
   properties = NODES[node['widgetType']].get_mandatory_fields()
   workflows = []
+
+  if node['widgetType'] == 'subworkflow-widget':
+    workflows = [{
+        'name': workflow.name,
+        'owner': workflow.owner.username,
+        'value': workflow.uuid
+      } for workflow in Document2.objects.filter(type='oozie-workflow2', owner=request.user)
+    ]
     
   response['status'] = 0
   response['properties'] = properties 
@@ -151,7 +151,7 @@ def add_node(request):
 
   if subworkflow:
     _properties.update({
-       'subworkflow': subworkflow['value']
+       'workflow': subworkflow['value']
     })
   _properties.update({
       'sla': Workflow.SLA_DEFAULT,
diff --git a/desktop/libs/liboozie/src/liboozie/submission2.py b/desktop/libs/liboozie/src/liboozie/submission2.py
index 08a169a..a071fc1 100644
--- a/desktop/libs/liboozie/src/liboozie/submission2.py
+++ b/desktop/libs/liboozie/src/liboozie/submission2.py
@@ -147,10 +147,10 @@ class Submission(object):
     if hasattr(self.job, 'actions'):
       for action in self.job.actions:
         # Make sure XML is there
-        # Don't support shared sub-worfklow
-        if action.node_type == 'subworkflow':
-          node = action.get_full_node()
-          sub_deploy = Submission(self.user, node.sub_workflow, self.fs, self.jt, self.properties)
+        # Don't support shared sub-worfklow, ore more than one level sub-workflow
+        if action.data['type'] == 'subworkflow':
+          workflow = Workflow(document=Document2.objects.get(uuid=action.data['properties']['workflow']))
+          sub_deploy = Submission(self.user, workflow, self.fs, self.jt, self.properties)
           sub_deploy.deploy()
 
     return deployment_dir
-- 
1.7.9.5

