From d01a411c2272e66bbb76195963314beef1f07b9c Mon Sep 17 00:00:00 2001
From: Romain Rigaux <romain@cloudera.com>
Date: Wed, 11 Mar 2015 10:33:23 -0700
Subject: [PATCH 1036/1173] [core] Sync imported workflow from the new Oozie
 Editor

---
 apps/oozie/src/oozie/views/editor2.py |    2 ++
 desktop/core/src/desktop/models.py    |   17 +++++++++++++++++
 2 files changed, 19 insertions(+)

diff --git a/apps/oozie/src/oozie/views/editor2.py b/apps/oozie/src/oozie/views/editor2.py
index e35e06e..6e9240e 100644
--- a/apps/oozie/src/oozie/views/editor2.py
+++ b/apps/oozie/src/oozie/views/editor2.py
@@ -205,6 +205,8 @@ def save_workflow(request):
   if subworkflows:
     dependencies = Document2.objects.filter(uuid__in=subworkflows)
     workflow_doc.dependencies = dependencies
+  else:
+    workflow_doc.dependencies = []
 
   if workflow['properties'].get('imported'): # We save and old format workflow to the latest
     workflow['properties']['imported'] = False
diff --git a/desktop/core/src/desktop/models.py b/desktop/core/src/desktop/models.py
index 6051665..93a99f8 100644
--- a/desktop/core/src/desktop/models.py
+++ b/desktop/core/src/desktop/models.py
@@ -325,6 +325,23 @@ class DocumentManager(models.Manager):
     except Exception, e:
       LOG.warn(force_unicode(e))
 
+    try:
+      with transaction.atomic():
+        for job in Document2.objects.all():
+          if job.doc.count() > 1:
+            LOG.warn('Deleting duplicate document %s for %s' % (job.doc.all(), job))
+            job.doc.all().delete()
+
+          if not job.doc.exists():
+            if job.type == 'oozie-workflow2':
+              extra = 'workflow2'
+            else:
+              extra = ''
+            doc = Document.objects.link(job, owner=job.owner, name=job.name, description=job.description, extra=extra)
+    except Exception, e:
+      LOG.warn(force_unicode(e))
+
+
     # Make sure doc have at least a tag
     try:
       for doc in Document.objects.filter(tags=None):
-- 
1.7.9.5

