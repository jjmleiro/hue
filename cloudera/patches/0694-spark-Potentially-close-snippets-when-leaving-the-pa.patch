From 938a8b37b0a7bb51b7b80b89b10c0b49a720237c Mon Sep 17 00:00:00 2001
From: Romain Rigaux <romain@cloudera.com>
Date: Wed, 28 Jan 2015 07:35:37 +0800
Subject: [PATCH 0694/1173] [spark] Potentially close snippets when leaving
 the page

---
 apps/spark/src/spark/api.py                |   11 +++++++----
 apps/spark/src/spark/templates/editor.mako |    7 +++++++
 2 files changed, 14 insertions(+), 4 deletions(-)

diff --git a/apps/spark/src/spark/api.py b/apps/spark/src/spark/api.py
index 9d6d869..95281dc 100644
--- a/apps/spark/src/spark/api.py
+++ b/apps/spark/src/spark/api.py
@@ -165,12 +165,15 @@ def open_notebook(request):
 def close_notebook(request):
   response = {'status': -1}
 
-  notebook_id = request.GET.get('notebook')
-  notebook = Notebook(document=Document2.objects.get(id=notebook_id)) # Todo perms
+  notebook = json.loads(request.POST.get('notebook', '{}'))  # Todo perms
   
   response['status'] = 0
   for snippet in notebook['snippets']:
-    get_api(request.user, snippet).close(snippet)
+    try:
+      if snippet['result']['handle']:      
+        get_api(request.user, snippet).close(snippet)
+    except QueryExpired:
+      pass
   response['message'] = _('Notebook closed !')
 
   return HttpResponse(json.dumps(response), mimetype="application/json")
@@ -182,7 +185,7 @@ def close_statement(request):
   notebook = json.loads(request.POST.get('notebook', '{}'))  # Todo perms
   snippet = json.loads(request.POST.get('snippet', '{}'))
 
-  try:
+  try:    
     response['result'] = get_api(request.user, snippet).close(snippet)
   except QueryExpired:
     pass
diff --git a/apps/spark/src/spark/templates/editor.mako b/apps/spark/src/spark/templates/editor.mako
index 1bf296d..180b49d 100644
--- a/apps/spark/src/spark/templates/editor.mako
+++ b/apps/spark/src/spark/templates/editor.mako
@@ -1007,6 +1007,13 @@ ${ commonheader(_('Query'), app_name, user, "68px") | n,unicode }
   ko.applyBindings(viewModel);
   viewModel.init();
 
+  $(document).ready(function () {
+    // Close the notebook snippets when leaving the page
+    window.onbeforeunload = function(e) {
+      viewModel.selectedNotebook().close();
+    };
+  });
+
   viewModel.assistSelectedMainObject.subscribe(function(newVal) {
     viewModel.assistContent().selectedMainObject(newVal);
     loadAssistFirstLevel();
-- 
1.7.9.5

