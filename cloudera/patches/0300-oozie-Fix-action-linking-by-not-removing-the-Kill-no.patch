From fb057996458a62a95028be9b475e3b2af7e99db0 Mon Sep 17 00:00:00 2001
From: Romain Rigaux <romain@cloudera.com>
Date: Wed, 19 Nov 2014 22:38:00 -0800
Subject: [PATCH 0300/1173] [oozie] Fix action linking by not removing the
 Kill node from the list

---
 apps/oozie/src/oozie/models2.py            |    5 ++---
 apps/oozie/static/js/workflow-editor.ko.js |   15 ++++++---------
 2 files changed, 8 insertions(+), 12 deletions(-)

diff --git a/apps/oozie/src/oozie/models2.py b/apps/oozie/src/oozie/models2.py
index 83c4a7a..43902f8 100644
--- a/apps/oozie/src/oozie/models2.py
+++ b/apps/oozie/src/oozie/models2.py
@@ -152,9 +152,8 @@ class Workflow():
     tmpl = 'editor/gen2/workflow.xml.mako'
 
     data = self.get_data()
-    nodes = [Node(node) for node in data['workflow']['nodes']]
-    end = nodes.pop(1)
-    nodes.append(end) # End at the end 
+    nodes = [Node(node) for node in data['workflow']['nodes'] if node['name'] != 'End'] + [
+                Node(node) for node in data['workflow']['nodes'] if node['name'] == 'End'] # End at the end
     node_mapping = dict([(node.id, node) for node in nodes])
     
     sub_wfs_ids = [node.data['properties']['workflow'] for node in nodes if node.data['type'] == 'subworkflow']
diff --git a/apps/oozie/static/js/workflow-editor.ko.js b/apps/oozie/static/js/workflow-editor.ko.js
index c862b86..dd15bb2 100644
--- a/apps/oozie/static/js/workflow-editor.ko.js
+++ b/apps/oozie/static/js/workflow-editor.ko.js
@@ -216,10 +216,7 @@ var Workflow = function (vm, workflow) {
           var node = new Node(_node);
         }
 
-        // Add to list of nodes before end
-        var end = self.nodes.pop();
         self.nodes.push(node);
-        self.nodes.push(end);
 
         if (vm.currentlyCreatingFork) {
           // Added to the side ?
@@ -234,13 +231,15 @@ var Workflow = function (vm, workflow) {
             var fork = new Node(vm.currentlyCreatedFork);
             var join = new Node(vm.currentlyCreatedJoin);
             
+	        self.nodes.push(fork);
+	        self.nodes.push(join);
+            
             var forkParent = self.getNodeById(vm.getWidgetPredecessor(parentWidget.id()).id());
             
             var afterParentId = ko.mapping.toJS(forkParent.get_link('to')).to;
             var afterParent = self.getNodeById(afterParentId);
             fork.children.push({'to': afterParentId, 'condition': ''});
             fork.children.push({'to': node.id(), 'condition': ''});
-            fork.children.push({'to': '33430f0f-ebfa-c3ec-f237-3e77efa03d0a', 'condition': 'default'});
             
             forkParent.get_link('to')['to'] = fork.id();
             
@@ -252,13 +251,9 @@ var Workflow = function (vm, workflow) {
             } else {
               afterParent.set_link('to', join.id());
             }
+            
 	        node.set_link('to', join.id());
 	        node.set_link('error', '17c9c895-5a16-7443-bb81-f34b30b21548');   
-	        
-	        var end = self.nodes.pop();
-	        self.nodes.push(fork);
-	        self.nodes.push(join);
-	        self.nodes.push(end);
           } else {
             // Just add to existing fork
         	var join = vm.getWidgetSuccessor(node.id()); 
@@ -897,6 +892,8 @@ var WorkflowEditorViewModel = function (layout_json, workflow_json, credentials_
       // Remove the join
       self.workflow.removeNode(_next.widgets()[0].id());
       self.removeWidgetById(_next.widgets()[0].id());
+      
+      node.children.push({'to': '33430f0f-ebfa-c3ec-f237-3e77efa03d0a', 'condition': 'default'});
 
       widget.widgetType("decision-widget");
       node.type("decision-widget");
-- 
1.7.9.5

