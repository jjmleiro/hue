From fe544a40f4ecb7e040b28d92273baa6f37dd7381 Mon Sep 17 00:00:00 2001
From: Romain Rigaux <romain@cloudera.com>
Date: Sun, 1 Feb 2015 11:14:30 -0800
Subject: [PATCH 0729/1173] [spark] Try to keep the graph legends when
 re-rerunning a snippet

---
 apps/spark/static/js/spark.ko.js |   11 ++++++-----
 1 file changed, 6 insertions(+), 5 deletions(-)

diff --git a/apps/spark/static/js/spark.ko.js b/apps/spark/static/js/spark.ko.js
index 4e66d5a..9de93ee 100644
--- a/apps/spark/static/js/spark.ko.js
+++ b/apps/spark/static/js/spark.ko.js
@@ -22,13 +22,13 @@ var Result = function (snippet, result) {
   self.type = ko.observable(typeof result.type != "undefined" && result.type != null ? result.type : 'table');
   self.hasResultset = ko.observable(typeof result.hasResultset != "undefined" && result.hasResultset != null ? result.hasResultset : true);
   self.handle = ko.observable({});
-  self.meta = ko.observableArray(typeof result.meta != "undefined" && result.meta != null ? result.meta : []);
-  self.meta.extend({ rateLimit: 50 });
+  self.meta = ko.observableArray(typeof result.meta != "undefined" && result.meta != null ? result.meta : []);  
   self.cleanedMeta = ko.computed(function(){
     return ko.utils.arrayFilter(self.meta(), function(item) {
       return item.name != ''
     });
   });
+  self.fetchedOnce = ko.observable(typeof result.fetchedOnce != "undefined" && result.fetchedOnce != null ? result.fetchedOnce : false);
   self.startTime = ko.observable(typeof result.startTime != "undefined" && result.startTime != null ? new Date(result.startTime) : new Date());
   self.endTime = ko.observable(typeof result.endTime != "undefined" && result.endTime != null ? new Date(result.endTime) : new Date());
   self.executionTime = ko.computed(function() {
@@ -85,7 +85,7 @@ var Result = function (snippet, result) {
     $.each(self.handle, function(key, val) {
       delete self.handle()[key];
     });
-    self.meta.removeAll();
+    self.fetchedOnce(false);
     self.data.removeAll();
     self.logs('');
     self.errors('');
@@ -301,7 +301,7 @@ var Snippet = function (vm, notebook, snippet) {
     $(".jHueNotify").hide();
     logGA('/execute/' + self.type());
 
-    if (self.result.meta().length > 0) {
+    if (self.result.fetchedOnce()) {
       self.close();
     }
     
@@ -347,7 +347,8 @@ var Snippet = function (vm, notebook, snippet) {
       if (data.status == 0) {
         rows -= data.result.data.length;
 
-        if (self.result.meta().length == 0) {
+        if (! self.result.fetchedOnce()) {
+          self.result.fetchedOnce(true);        
    	      data.result.meta.unshift({type: "INT_TYPE", name: "", comment: null});
    	      self.result.meta(data.result.meta);
    	      self.result.type(data.result.type);
-- 
1.7.9.5

