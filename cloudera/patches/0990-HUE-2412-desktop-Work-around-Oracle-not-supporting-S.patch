From 807502beb1531018ec708081483c194b28dc3fd8 Mon Sep 17 00:00:00 2001
From: Erick Tryzelaar <erickt@cloudera.com>
Date: Thu, 5 Mar 2015 15:12:07 -0800
Subject: [PATCH 0990/1173] HUE-2412 [desktop] Work around Oracle not
 supporting `SELECT DISTINCT` with CLOBs

---
 desktop/core/src/desktop/api.py |   21 +++++++++++++++++++--
 1 file changed, 19 insertions(+), 2 deletions(-)

diff --git a/desktop/core/src/desktop/api.py b/desktop/core/src/desktop/api.py
index eb6ee1e..4e2e103 100644
--- a/desktop/core/src/desktop/api.py
+++ b/desktop/core/src/desktop/api.py
@@ -26,6 +26,7 @@ from django.core.urlresolvers import reverse
 from django.utils import html
 from django.utils.translation import ugettext as _
 
+import desktop.conf
 from desktop.lib.django_util import JsonResponse
 from desktop.lib.i18n import force_unicode
 from desktop.models import Document, DocumentTag
@@ -37,8 +38,24 @@ LOG = logging.getLogger(__name__)
 def _get_docs(user):
   history_tag = DocumentTag.objects.get_history_tag(user)
 
-  return Document.objects.get_docs(user).exclude(tags__in=[history_tag]).select_related('owner', 'content_type') \
-        .prefetch_related('tags','documentpermission_set').defer(None).order_by('-last_modified')[:100]
+  query = Document.objects.get_docs(user) \
+      .exclude(tags__in=[history_tag]). \
+      select_related('owner', 'content_type') \
+      .prefetch_related('tags','documentpermission_set')
+
+  # Work around Oracle not supporting SELECT DISTINCT with the CLOB type.
+  if desktop.conf.DATABASE.ENGINE.get() == 'django.db.backends.oracle':
+    query = query.only('id')
+  else:
+    query = query.defer(None)
+
+  docs = query.order_by('-last_modified')[:100]
+
+  if desktop.conf.DATABASE.ENGINE.get() == 'django.db.backends.oracle':
+    ids = [doc.id for doc in docs]
+    return Document.objects.filter(id__in=ids).defer(None)
+  else:
+    return docs
 
 
 def massaged_tags_for_json(docs, user):
-- 
1.7.9.5

