From ac7c1ff0b867ae525fef51495cfb4fea319b725d Mon Sep 17 00:00:00 2001
From: Romain Rigaux <romain@cloudera.com>
Date: Thu, 12 Mar 2015 14:40:03 -0700
Subject: [PATCH 1056/1173] [search] Make corrrect the counts of an esc range
 facet

Fix the rounding of upper side too.
---
 apps/search/src/search/models.py        |    4 ++--
 desktop/libs/libsolr/src/libsolr/api.py |    2 +-
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/apps/search/src/search/models.py b/apps/search/src/search/models.py
index 72e2f40..138db4a 100644
--- a/apps/search/src/search/models.py
+++ b/apps/search/src/search/models.py
@@ -468,13 +468,12 @@ def range_pair(field, cat, fq_filter, iterable, end, collection_facet):
   a, to = itertools.tee(iterable)
   next(to, None)
   counts = iterable[1::2]
-  total_counts = 0
+  total_counts = counts.pop(0) if collection_facet['properties']['sort'] == 'asc' else 0
 
   for element in a:
     next(to, None)
     to_value = next(to, end)
     count = next(a)
-    total_counts += counts.pop(0)
 
     pairs.append({
         'field': field, 'from': element, 'value': count, 'to': to_value, 'selected': element in selected_values,
@@ -483,6 +482,7 @@ def range_pair(field, cat, fq_filter, iterable, end, collection_facet):
         'total_counts': total_counts,
         'is_up': is_up
     })
+    total_counts += counts.pop(0) if counts else 0
 
   if collection_facet['properties']['sort'] == 'asc' and collection_facet['type'] != 'range-up':
     pairs.reverse()
diff --git a/desktop/libs/libsolr/src/libsolr/api.py b/desktop/libs/libsolr/src/libsolr/api.py
index 96b717f..4d8175d 100644
--- a/desktop/libs/libsolr/src/libsolr/api.py
+++ b/desktop/libs/libsolr/src/libsolr/api.py
@@ -101,7 +101,7 @@ class SolrApi(object):
                     utf_quoter('%s%s:[%s TO %s}' % ('-' if field['exclude'] else '', fq['field'], f['from'], f['to']))) for field, f in zip(fq['filter'], fq['properties'])])),)
       elif fq['type'] == 'range-up':
         params += (('fq', '{!tag=%s}' % fq['field'] + ' '.join([urllib.unquote(
-                    utf_quoter('%s%s:[%s TO %s]' % ('-' if field['exclude'] else '', fq['field'], f['from'] if fq['is_up'] else '*', '*' if fq['is_up'] else f['from'])))
+                    utf_quoter('%s%s:[%s TO %s}' % ('-' if field['exclude'] else '', fq['field'], f['from'] if fq['is_up'] else '*', '*' if fq['is_up'] else f['from'])))
                                                           for field, f in zip(fq['filter'], fq['properties'])])),)
     return params
 
-- 
1.7.9.5

