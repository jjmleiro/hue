From 2fa8ef31b5bc8ebc7fa748021c8a186695d2e62c Mon Sep 17 00:00:00 2001
From: Ivan Orlov <ivanorlo@amazon.com>
Date: Mon, 6 Oct 2014 18:20:45 -0700
Subject: [PATCH 0026/1173] [core] Add csrf token in non-jQuery requests

---
 .../core/src/desktop/templates/common_header.mako  |   13 ++++++-------
 1 file changed, 6 insertions(+), 7 deletions(-)

diff --git a/desktop/core/src/desktop/templates/common_header.mako b/desktop/core/src/desktop/templates/common_header.mako
index adef806..7c7383f 100644
--- a/desktop/core/src/desktop/templates/common_header.mako
+++ b/desktop/core/src/desktop/templates/common_header.mako
@@ -181,13 +181,12 @@ from django.utils.translation import ugettext as _
         // these HTTP methods do not require CSRF protection
         return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
       }
-      $.ajaxSetup({
-        beforeSend: function(xhr, settings) {
-          if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
-            xhr.setRequestHeader("X-CSRFToken", csrftoken);
-          }
-        }
-      });
+
+      var xrhsend = XMLHttpRequest.prototype.send;
+      XMLHttpRequest.prototype.send = function(data) {
+        this.setRequestHeader('X-CSRFToken', csrftoken);
+        return xrhsend.apply(this, arguments);
+      }
       /////
 
       // prevents framebusting and clickjacking
-- 
1.7.9.5

