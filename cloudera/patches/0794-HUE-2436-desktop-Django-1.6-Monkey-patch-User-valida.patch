From 7066d567f2c9ce9b2553fdf8aca3d31d3271b0ea Mon Sep 17 00:00:00 2001
From: Erick Tryzelaar <erick.tryzelaar@gmail.com>
Date: Wed, 21 Jan 2015 19:10:24 -0800
Subject: [PATCH 0794/1173] HUE-2436 [desktop] Django-1.6: Monkey-patch User
 validator to work with our username regex

---
 desktop/core/src/desktop/monkey_patches.py |   43 ++++++++++++++++++++++++++++
 desktop/core/src/desktop/urls.py           |    9 ++++++
 2 files changed, 52 insertions(+)
 create mode 100644 desktop/core/src/desktop/monkey_patches.py

diff --git a/desktop/core/src/desktop/monkey_patches.py b/desktop/core/src/desktop/monkey_patches.py
new file mode 100644
index 0000000..72635a2
--- /dev/null
+++ b/desktop/core/src/desktop/monkey_patches.py
@@ -0,0 +1,43 @@
+#!/usr/bin/env python
+# Licensed to Cloudera, Inc. under one
+# or more contributor license agreements.  See the NOTICE file
+# distributed with this work for additional information
+# regarding copyright ownership.  Cloudera, Inc. licenses this file
+# to you under the Apache License, Version 2.0 (the
+# "License"); you may not use this file except in compliance
+# with the License.  You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+
+import re
+
+from django.contrib.auth.models import User
+from django.core.validators import RegexValidator
+
+from desktop.lib.django_util import get_username_re_rule
+
+def monkey_patch_username_validator():
+  """
+  In 1.6, the `User.username` field gained some validation rules to check that
+  it conformed to a particular regex. Unfortunately we use to support a more
+  liberal username scheme. The proper solution would be to use our own custom
+  user model, but that touches a lot of code. It's easier if we just modify the
+  regular expression inside the username validator.
+  """
+
+  username = User._meta.get_field("username")
+
+  regex = re.compile('^%s$' % get_username_re_rule())
+
+  for validator in username.validators:
+    if isinstance(validator, RegexValidator):
+      validator.regex = regex
+
+
+monkey_patch_username_validator()
diff --git a/desktop/core/src/desktop/urls.py b/desktop/core/src/desktop/urls.py
index fe993e7..e508e50 100644
--- a/desktop/core/src/desktop/urls.py
+++ b/desktop/core/src/desktop/urls.py
@@ -19,6 +19,15 @@ import logging
 import os
 import re
 
+# FIXME: This could be replaced with hooking into the `AppConfig.ready()`
+# signal in Django 1.7:
+#
+# https://docs.djangoproject.com/en/1.7/ref/applications/#django.apps.AppConfig.ready
+#
+# For now though we have to load in the monkey patches here because we know
+# this file has been loaded after `desktop.settings` has been loaded.
+import desktop.monkey_patches
+
 from django.conf import settings
 from django.conf.urls import include, patterns
 from django.contrib import admin
-- 
1.7.9.5

