From d3bc9340edef1b1488e8709b8b501cd74b20bbec Mon Sep 17 00:00:00 2001
From: Romain Rigaux <romain@cloudera.com>
Date: Wed, 11 Mar 2015 15:46:21 -0700
Subject: [PATCH 1044/1173] [oozie] Adding a Bundle example to the New Editor

---
 .../src/oozie/fixtures/initial_oozie_examples.json |   29 +++++++++++++++++++-
 apps/oozie/src/oozie/models2.py                    |    7 +++--
 .../oozie/templates/editor2/gen/bundle.xml.mako    |    2 +-
 desktop/core/src/desktop/models.py                 |    2 ++
 4 files changed, 36 insertions(+), 4 deletions(-)
 create mode 100644 apps/oozie/examples/bundles/copy-files/empty

diff --git a/apps/oozie/examples/bundles/copy-files/empty b/apps/oozie/examples/bundles/copy-files/empty
new file mode 100644
index 0000000..e69de29
diff --git a/apps/oozie/src/oozie/fixtures/initial_oozie_examples.json b/apps/oozie/src/oozie/fixtures/initial_oozie_examples.json
index ac47bd2..b3f5cd9 100644
--- a/apps/oozie/src/oozie/fixtures/initial_oozie_examples.json
+++ b/apps/oozie/src/oozie/fixtures/initial_oozie_examples.json
@@ -63,8 +63,35 @@
         false
       ]
     ],
-    "data": "{\"end_date\": {\"name\": \"end_date\", \"value\": \"2013-06-05T00:00Z\"}, \"variables\": [{\"shared_dataset_uuid\": \"\", \"is_advanced_start_instance\": false, \"show_advanced\": false, \"start_instance\": \"0\", \"timezone\": \"America/Los_Angeles\", \"end_instance\": \"0\", \"same_timezone\": true, \"uuid\": \"a96e02cd-70b3-5faf-1633-963d4251ce23\", \"frequency_number\": \"1\", \"dataset_variable\": \"/user/hue/oozie/workspaces/data/${YEAR}${MONTH}${DAY}\", \"start\": \"2015-03-11T20:51:48.374Z\", \"same_frequency\": true, \"advanced_start_instance\": \"${coord:current(0)}\", \"advanced_end_instance\": \"${coord:current(0)}\", \"instance_choice\": \"default\", \"dataset_type\": \"input_path\", \"use_done_flag\": false, \"done_flag\": \"_SUCCESS\", \"same_start\": true, \"frequency_unit\": \"days\", \"workflow_variable\": \"input\", \"is_advanced_end_instance\": false}, {\"shared_dataset_uuid\": \"\", \"is_advanced_start_instance\": false, \"show_advanced\": false, \"start_instance\": \"0\", \"timezone\": \"America/Los_Angeles\", \"end_instance\": \"0\", \"same_timezone\": true, \"uuid\": \"3748a9a6-5889-af8a-41a7-100d85a6d5be\", \"frequency_number\": \"1\", \"dataset_variable\": \"output/${YEAR}${MONTH}${DAY}\", \"start\": \"2015-03-11T20:51:48.421Z\", \"same_frequency\": true, \"advanced_start_instance\": \"${coord:current(0)}\", \"advanced_end_instance\": \"${coord:current(0)}\", \"instance_choice\": \"default\", \"dataset_type\": \"output_path\", \"use_done_flag\": false, \"done_flag\": \"_SUCCESS\", \"same_start\": true, \"frequency_unit\": \"days\", \"workflow_variable\": \"output\", \"is_advanced_end_instance\": false}], \"isDirty\": true, \"showAdvancedFrequencyUI\": true, \"variablesUI\": [\"parameter\", \"input_path\", \"output_path\"], \"workflowParameters\": [{\"name\": \"input\", \"value\": \"/user/hue/oozie/workspaces/data/sonnets.txt\"}, {\"name\": \"output\", \"value\": \"here\"}], \"properties\": {\"job_xml\": \"\", \"end\": \"${end_date}\", \"parameters\": [{\"name\": \"oozie.use.system.libpath\", \"value\": true}, {\"name\": \"start_date\", \"value\": \"2013-06-01T00:00Z\"}, {\"name\": \"end_date\", \"value\": \"2013-06-05T00:00Z\"}], \"frequency_number\": 1, \"sla_enabled\": false, \"deployment_dir\": \"/user/hue/oozie/workspaces/coordinators/daily-copy\", \"cron_frequency\": \"0 0 * * *\", \"frequency_unit\": \"days\", \"workflow\": \"2d667ab2-70f9-c2bf-0726-abe84fa7130d\", \"cron_advanced\": false, \"start\": \"${start_date}\", \"sla_workflow_enabled\": false, \"schema_version\": \"uri:oozie:coordinator:0.2\", \"timeout\": null, \"timezone\": \"America/Los_Angeles\", \"credentials\": [], \"execution\": \"FIFO\", \"sla\": [{\"key\": \"enabled\", \"value\": false}, {\"key\": \"nominal-time\", \"value\": \"${nominal_time}\"}, {\"key\": \"should-start\", \"value\": \"\"}, {\"key\": \"should-end\", \"value\": \"${30 * MINUTES}\"}, {\"key\": \"max-duration\", \"value\": \"\"}, {\"key\": \"alert-events\", \"value\": \"\"}, {\"key\": \"alert-contact\", \"value\": \"\"}, {\"key\": \"notification-msg\", \"value\": \"\"}, {\"key\": \"upstream-apps\", \"value\": \"\"}]}, \"uuid\": \"1d1a9eec-d969-4cd6-c3c4-cb5b78f52f38\", \"name\": \"My Coordinator\", \"id\": 50003, \"start_date\": {\"name\": \"start_date\", \"value\": \"2013-06-01T14:52:00\"}}",
+    "data": "{\"end_date\": {\"name\": \"end_date\", \"value\": \"2013-06-05T00:00Z\"}, \"variables\": [{\"shared_dataset_uuid\": \"\", \"is_advanced_start_instance\": false, \"show_advanced\": false, \"start_instance\": \"0\", \"timezone\": \"America/Los_Angeles\", \"end_instance\": \"0\", \"same_timezone\": true, \"uuid\": \"a96e02cd-70b3-5faf-1633-963d4251ce23\", \"frequency_number\": \"1\", \"dataset_variable\": \"/user/hue/oozie/workspaces/data/${YEAR}${MONTH}${DAY}\", \"start\": \"2015-03-11T20:51:48.374Z\", \"same_frequency\": true, \"advanced_start_instance\": \"${coord:current(0)}\", \"advanced_end_instance\": \"${coord:current(0)}\", \"instance_choice\": \"default\", \"dataset_type\": \"input_path\", \"use_done_flag\": false, \"done_flag\": \"_SUCCESS\", \"same_start\": true, \"frequency_unit\": \"days\", \"workflow_variable\": \"input\", \"is_advanced_end_instance\": false}, {\"shared_dataset_uuid\": \"\", \"is_advanced_start_instance\": false, \"show_advanced\": false, \"start_instance\": \"0\", \"timezone\": \"America/Los_Angeles\", \"end_instance\": \"0\", \"same_timezone\": true, \"uuid\": \"3748a9a6-5889-af8a-41a7-100d85a6d5be\", \"frequency_number\": \"1\", \"dataset_variable\": \"${directory}/${YEAR}${MONTH}${DAY}\", \"start\": \"2015-03-11T20:51:48.421Z\", \"same_frequency\": true, \"advanced_start_instance\": \"${coord:current(0)}\", \"advanced_end_instance\": \"${coord:current(0)}\", \"instance_choice\": \"default\", \"dataset_type\": \"output_path\", \"use_done_flag\": false, \"done_flag\": \"_SUCCESS\", \"same_start\": true, \"frequency_unit\": \"days\", \"workflow_variable\": \"output\", \"is_advanced_end_instance\": false}], \"isDirty\": true, \"showAdvancedFrequencyUI\": true, \"variablesUI\": [\"parameter\", \"input_path\", \"output_path\"], \"workflowParameters\": [{\"name\": \"input\", \"value\": \"/user/hue/oozie/workspaces/data/sonnets.txt\"}, {\"name\": \"output\", \"value\": \"here\"}], \"id\": 50003, \"name\": \"My Coordinator\", \"uuid\": \"1d1a9eec-d969-4cd6-c3c4-cb5b78f52f38\", \"properties\": {\"job_xml\": \"\", \"end\": \"${end_date}\", \"parameters\": [{\"name\": \"oozie.use.system.libpath\", \"value\": true}, {\"name\": \"start_date\", \"value\": \"2013-06-01T00:00Z\"}, {\"name\": \"end_date\", \"value\": \"2013-06-05T00:00Z\"}, {\"name\": \"directory\", \"value\": \"coordinator-output\"}], \"frequency_number\": 1, \"sla_enabled\": false, \"deployment_dir\": \"/user/hue/oozie/workspaces/coordinators/daily-copy\", \"cron_frequency\": \"0 0 * * *\", \"frequency_unit\": \"days\", \"workflow\": \"2d667ab2-70f9-c2bf-0726-abe84fa7130d\", \"cron_advanced\": false, \"start\": \"${start_date}\", \"sla_workflow_enabled\": false, \"schema_version\": \"uri:oozie:coordinator:0.2\", \"timeout\": null, \"timezone\": \"America/Los_Angeles\", \"credentials\": [], \"execution\": \"FIFO\", \"sla\": [{\"key\": \"enabled\", \"value\": false}, {\"key\": \"nominal-time\", \"value\": \"${nominal_time}\"}, {\"key\": \"should-start\", \"value\": \"\"}, {\"key\": \"should-end\", \"value\": \"${30 * MINUTES}\"}, {\"key\": \"max-duration\", \"value\": \"\"}, {\"key\": \"alert-events\", \"value\": \"\"}, {\"key\": \"alert-contact\", \"value\": \"\"}, {\"key\": \"notification-msg\", \"value\": \"\"}, {\"key\": \"upstream-apps\", \"value\": \"\"}]}, \"start_date\": {\"name\": \"start_date\", \"value\": \"2013-06-01T00:00Z\"}}",
     "name": "My Coordinator"
   }
 }
+,
+{
+  "pk": 50004,
+  "model": "desktop.document2",
+  "fields": {
+    "uuid": "d1d4507d-fd70-9c44-02f1-548c9cf71364",
+    "extra": "",
+    "type": "oozie-bundle2",
+    "description": "",
+    "tags": [],
+    "is_history": false,
+    "last_modified": "2015-03-11T15:39:21.448",
+    "version": 1,
+    "owner": [
+      "sample"
+    ],
+    "dependencies": [
+      [
+        "1d1a9eec-d969-4cd6-c3c4-cb5b78f52f38",
+        1,
+        false
+      ]
+    ],
+    "data": "{\"properties\": {\"deployment_dir\": \"/user/hue/oozie/workspaces/bundle/copy-files\", \"kickoff\": \"2015-03-11T15:22:31\", \"parameters\": [{\"name\": \"oozie.use.system.libpath\", \"value\": \"true\"}, {\"name\": \"root_output\", \"value\": \"bundle-example\"}], \"schema_version\": \"uri:oozie:bundle:0.2\"}, \"uuid\": \"d1d4507d-fd70-9c44-02f1-548c9cf71364\", \"isDirty\": true, \"coordinators\": [{\"coordinator\": \"1d1a9eec-d969-4cd6-c3c4-cb5b78f52f38\", \"properties\": [{\"name\": \"directory\", \"value\": \"${root_output}/coordinator1\"}, {\"name\": \"start_date\", \"value\": \"2013-06-01T00:00Z\"}, {\"name\": \"end_date\", \"value\": \"2013-06-05T00:00Z\"}]}, {\"coordinator\": \"1d1a9eec-d969-4cd6-c3c4-cb5b78f52f38\", \"properties\": [{\"name\": \"directory\", \"value\": \"${root_output}/coordinator2\"}, {\"name\": \"start_date\", \"value\": \"2013-06-01T00:00Z\"}, {\"name\": \"end_date\", \"value\": \"2013-06-05T00:00Z\"}]}], \"id\": 50004, \"name\": \"Copy Files\"}",
+    "name": "Copy Files"
+  }
+}
 ]
diff --git a/apps/oozie/src/oozie/models2.py b/apps/oozie/src/oozie/models2.py
index 2e337c5..69f0526 100644
--- a/apps/oozie/src/oozie/models2.py
+++ b/apps/oozie/src/oozie/models2.py
@@ -1871,7 +1871,7 @@ class Bundle(Job):
               'deployment_dir': '',
               'schema_version': 'uri:oozie:bundle:0.2',
               'kickoff': datetime.today(),
-              'parameters': [{'name': 'oozie.use.system.libpath', 'value': True}]
+              'parameters': [{'name': 'oozie.use.system.libpath', 'value': 'true'}]
           }
       }
 
@@ -1956,7 +1956,10 @@ class Bundle(Job):
     for param in find_json_parameters([self.data['properties']]):
       params.add(param)
 
-    return dict([(param, '') for param in list(params)])
+    # Remove the ones filled up by bundle
+    removable_names = [p['name']  for coord in self.data['coordinators'] for p in coord['properties']]
+
+    return dict([(param, '') for param in list(params) if param not in removable_names])
 
   def get_absolute_url(self):
     return reverse('oozie:edit_bundle') + '?bundle=%s' % self.id
diff --git a/apps/oozie/src/oozie/templates/editor2/gen/bundle.xml.mako b/apps/oozie/src/oozie/templates/editor2/gen/bundle.xml.mako
index bf39569..a6b5fac 100644
--- a/apps/oozie/src/oozie/templates/editor2/gen/bundle.xml.mako
+++ b/apps/oozie/src/oozie/templates/editor2/gen/bundle.xml.mako
@@ -28,7 +28,7 @@
     % for p in bundle.data['properties']['parameters']:
     <property>
         <name>${ p['name'] }</name>
-        <value>${ json.dumps(p['value']) }</value>
+        <value>${ p['value'] }</value>
     </property>
     % endfor
   </parameters>
diff --git a/desktop/core/src/desktop/models.py b/desktop/core/src/desktop/models.py
index 2e91a1b..f3e6994 100644
--- a/desktop/core/src/desktop/models.py
+++ b/desktop/core/src/desktop/models.py
@@ -337,6 +337,8 @@ class DocumentManager(models.Manager):
               extra = 'workflow2'
             elif job.type == 'oozie-coordinator2':
               extra = 'coordinator2'
+            elif job.type == 'oozie-bundle2':
+              extra = 'bundle2'
             else:
               extra = ''
             doc = Document.objects.link(job, owner=job.owner, name=job.name, description=job.description, extra=extra)
-- 
1.7.9.5

