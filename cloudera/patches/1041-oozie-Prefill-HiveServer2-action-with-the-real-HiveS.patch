From 8f0a40f0acf778e0f9db12216280344698a02056 Mon Sep 17 00:00:00 2001
From: Romain Rigaux <romain@cloudera.com>
Date: Wed, 11 Mar 2015 12:13:11 -0700
Subject: [PATCH 1041/1173] [oozie] Prefill HiveServer2 action with the real
 HiveServer2 address

---
 apps/oozie/src/oozie/models2.py |   13 ++++++++++++-
 1 file changed, 12 insertions(+), 1 deletion(-)

diff --git a/apps/oozie/src/oozie/models2.py b/apps/oozie/src/oozie/models2.py
index 90c68d3..ab17e96 100644
--- a/apps/oozie/src/oozie/models2.py
+++ b/apps/oozie/src/oozie/models2.py
@@ -31,6 +31,7 @@ from django.utils.translation import ugettext as _
 
 from desktop.lib import django_mako
 from desktop.lib.exceptions_renderable import PopupException
+from desktop.lib.i18n import smart_str
 from desktop.lib.json_utils import JSONEncoderForHTML
 from desktop.models import Document2
 
@@ -579,6 +580,16 @@ class HiveAction(Action):
     return [cls.FIELDS['script_path'], cls.FIELDS['hive_xml']]
 
 
+def _get_hiveserver2_url():
+  try:
+    from beeswax.conf import HIVE_SERVER_HOST, HIVE_SERVER_PORT
+    return 'jdbc:hive2://%s:%s/default' % (HIVE_SERVER_HOST.get(), HIVE_SERVER_PORT.get())
+  except Exception, e:
+    # Might fail is Hive is disabled
+    LOG.warn('Could not guess HiveServer2 URL: %s' % smart_str(e))
+    return 'jdbc:hive2://localhost:10000/default'
+
+
 class HiveServer2Action(Action):
   TYPE = 'hive2'
   FIELDS = {
@@ -600,7 +611,7 @@ class HiveServer2Action(Action):
      'jdbc_url': {
           'name': 'jdbc_url',
           'label': _('JDBC URL'),
-          'value': 'jdbc:hive2://localhost:10000/default',
+          'value': _get_hiveserver2_url(),
           'help_text': _('JDBC URL for the Hive Server 2. Beeline will use this to know where to connect to.'),
           'type': ''
      },
-- 
1.7.9.5

