From 304640e356d4446573d1f0dd8554551b30b411de Mon Sep 17 00:00:00 2001
From: Romain Rigaux <romain@cloudera.com>
Date: Wed, 11 Mar 2015 07:02:47 -0700
Subject: [PATCH 1037/1173] [oozie] Add Spark Example for new Editor

---
 .../src/oozie/fixtures/initial_oozie_examples.json |   22 +++++++++++
 .../src/oozie/management/commands/oozie_setup.py   |   10 ++++-
 .../oozie/templates/editor2/common_workflow.mako   |   39 ++++++++++----------
 desktop/core/src/desktop/models.py                 |    4 ++
 4 files changed, 53 insertions(+), 22 deletions(-)
 create mode 100644 apps/oozie/src/oozie/fixtures/initial_oozie_examples.json

diff --git a/apps/oozie/src/oozie/fixtures/initial_oozie_examples.json b/apps/oozie/src/oozie/fixtures/initial_oozie_examples.json
new file mode 100644
index 0000000..56bb396
--- /dev/null
+++ b/apps/oozie/src/oozie/fixtures/initial_oozie_examples.json
@@ -0,0 +1,22 @@
+[
+{
+  "pk": 50000,
+  "model": "desktop.document2",
+  "fields": {
+    "uuid": "2d667ab2-70f9-c2bf-0726-abe84fa7130d",
+    "extra": "",
+    "type": "oozie-workflow2",
+    "description": "Copy a file by launching a Spark Java program",
+    "tags": [],
+    "is_history": false,
+    "last_modified": "2015-03-11T08:19:12.616",
+    "version": 1,
+    "owner": [
+      "sample"
+    ],
+    "dependencies": [],
+    "data": "{\"layout\": [{\"oozieRows\": [{\"enableOozieDropOnBefore\": true, \"enableOozieDropOnSide\": true, \"enableOozieDrop\": false, \"widgets\": [{\"status\": \"\", \"logsURL\": \"\", \"name\": \"Spark\", \"widgetType\": \"spark-widget\", \"oozieMovable\": true, \"ooziePropertiesExpanded\": false, \"properties\": {}, \"isLoading\": true, \"offset\": 0, \"actionURL\": \"\", \"progress\": 0, \"klass\": \"card card-widget span12\", \"oozieExpanded\": false, \"id\": \"d909ca7e-b1d9-f8f3-9b57-cddf9a8e75a7\", \"size\": 12}], \"id\": \"aa5b3738-38ee-9975-fdef-a0e91ffa45b1\", \"columns\": []}], \"rows\": [{\"enableOozieDropOnBefore\": true, \"enableOozieDropOnSide\": true, \"enableOozieDrop\": false, \"widgets\": [{\"status\": \"\", \"logsURL\": \"\", \"name\": \"Start\", \"widgetType\": \"start-widget\", \"oozieMovable\": false, \"ooziePropertiesExpanded\": false, \"properties\": {}, \"isLoading\": true, \"offset\": 0, \"actionURL\": \"\", \"progress\": 0, \"klass\": \"card card-widget span12\", \"oozieExpanded\": false, \"id\": \"3f107997-04cc-8733-60a9-a4bb62cebffc\", \"size\": 12}], \"id\": \"70913349-1e56-9b10-0938-70b908077c05\", \"columns\": []}, {\"enableOozieDropOnBefore\": true, \"enableOozieDropOnSide\": true, \"enableOozieDrop\": false, \"widgets\": [{\"status\": \"\", \"logsURL\": \"\", \"name\": \"Spark\", \"widgetType\": \"spark-widget\", \"oozieMovable\": true, \"ooziePropertiesExpanded\": false, \"properties\": {}, \"isLoading\": true, \"offset\": 0, \"actionURL\": \"\", \"progress\": 0, \"klass\": \"card card-widget span12\", \"oozieExpanded\": false, \"id\": \"d909ca7e-b1d9-f8f3-9b57-cddf9a8e75a7\", \"size\": 12}], \"id\": \"aa5b3738-38ee-9975-fdef-a0e91ffa45b1\", \"columns\": []}, {\"enableOozieDropOnBefore\": true, \"enableOozieDropOnSide\": true, \"enableOozieDrop\": false, \"widgets\": [{\"status\": \"\", \"logsURL\": \"\", \"name\": \"End\", \"widgetType\": \"end-widget\", \"oozieMovable\": false, \"ooziePropertiesExpanded\": false, \"properties\": {}, \"isLoading\": true, \"offset\": 0, \"actionURL\": \"\", \"progress\": 0, \"klass\": \"card card-widget span12\", \"oozieExpanded\": false, \"id\": \"33430f0f-ebfa-c3ec-f237-3e77efa03d0a\", \"size\": 12}], \"id\": \"60da4cd8-2f75-776a-589a-4f06b0f4d695\", \"columns\": []}, {\"enableOozieDropOnBefore\": true, \"enableOozieDropOnSide\": true, \"enableOozieDrop\": false, \"widgets\": [{\"status\": \"\", \"logsURL\": \"\", \"name\": \"Kill\", \"widgetType\": \"kill-widget\", \"oozieMovable\": true, \"ooziePropertiesExpanded\": false, \"properties\": {}, \"isLoading\": true, \"offset\": 0, \"actionURL\": \"\", \"progress\": 0, \"klass\": \"card card-widget span12\", \"oozieExpanded\": false, \"id\": \"17c9c895-5a16-7443-bb81-f34b30b21548\", \"size\": 12}], \"id\": \"22b45c61-413a-fc56-02e5-21d2f50882bd\", \"columns\": []}], \"oozieEndRow\": {\"enableOozieDropOnBefore\": true, \"enableOozieDropOnSide\": true, \"enableOozieDrop\": false, \"widgets\": [{\"status\": \"\", \"logsURL\": \"\", \"name\": \"End\", \"widgetType\": \"end-widget\", \"oozieMovable\": false, \"ooziePropertiesExpanded\": false, \"properties\": {}, \"isLoading\": true, \"offset\": 0, \"actionURL\": \"\", \"progress\": 0, \"klass\": \"card card-widget span12\", \"oozieExpanded\": false, \"id\": \"33430f0f-ebfa-c3ec-f237-3e77efa03d0a\", \"size\": 12}], \"id\": \"60da4cd8-2f75-776a-589a-4f06b0f4d695\", \"columns\": []}, \"oozieKillRow\": {\"enableOozieDropOnBefore\": true, \"enableOozieDropOnSide\": true, \"enableOozieDrop\": false, \"widgets\": [{\"status\": \"\", \"logsURL\": \"\", \"name\": \"Kill\", \"widgetType\": \"kill-widget\", \"oozieMovable\": true, \"ooziePropertiesExpanded\": false, \"properties\": {}, \"isLoading\": true, \"offset\": 0, \"actionURL\": \"\", \"progress\": 0, \"klass\": \"card card-widget span12\", \"oozieExpanded\": false, \"id\": \"17c9c895-5a16-7443-bb81-f34b30b21548\", \"size\": 12}], \"id\": \"22b45c61-413a-fc56-02e5-21d2f50882bd\", \"columns\": []}, \"enableOozieDropOnAfter\": true, \"oozieStartRow\": {\"enableOozieDropOnBefore\": true, \"enableOozieDropOnSide\": true, \"enableOozieDrop\": false, \"widgets\": [{\"status\": \"\", \"logsURL\": \"\", \"name\": \"Start\", \"widgetType\": \"start-widget\", \"oozieMovable\": false, \"ooziePropertiesExpanded\": false, \"properties\": {}, \"isLoading\": true, \"offset\": 0, \"actionURL\": \"\", \"progress\": 0, \"klass\": \"card card-widget span12\", \"oozieExpanded\": false, \"id\": \"3f107997-04cc-8733-60a9-a4bb62cebffc\", \"size\": 12}], \"id\": \"70913349-1e56-9b10-0938-70b908077c05\", \"columns\": []}, \"klass\": \"card card-home card-column span12\", \"enableOozieDropOnBefore\": true, \"drops\": [\"temp\"], \"id\": \"1e9fc64a-7838-2e9d-1689-31b1c6410399\", \"size\": 12}], \"workflow\": {\"properties\": {\"job_xml\": \"\", \"description\": \"\", \"wf1_id\": null, \"sla_enabled\": false, \"deployment_dir\": \"/user/hue/oozie/workspaces/workflows/spark-scala\", \"schema_version\": \"uri:oozie:workflow:0.5\", \"properties\": [], \"sla_workflow_enabled\": false, \"show_arrows\": true, \"credentials\": [], \"parameters\": [{\"name\": \"oozie.use.system.libpath\", \"value\": true}], \"sla\": [{\"value\": false, \"key\": \"enabled\"}, {\"value\": \"${nominal_time}\", \"key\": \"nominal-time\"}, {\"value\": \"\", \"key\": \"should-start\"}, {\"value\": \"${30 * MINUTES}\", \"key\": \"should-end\"}, {\"value\": \"\", \"key\": \"max-duration\"}, {\"value\": \"\", \"key\": \"alert-events\"}, {\"value\": \"\", \"key\": \"alert-contact\"}, {\"value\": \"\", \"key\": \"notification-msg\"}, {\"value\": \"\", \"key\": \"upstream-apps\"}]}, \"name\": \"Spark\", \"versions\": [\"uri:oozie:workflow:0.4\", \"uri:oozie:workflow:0.4.5\", \"uri:oozie:workflow:0.5\"], \"isDirty\": false, \"movedNode\": null, \"linkMapping\": {\"33430f0f-ebfa-c3ec-f237-3e77efa03d0a\": [], \"3f107997-04cc-8733-60a9-a4bb62cebffc\": [\"d909ca7e-b1d9-f8f3-9b57-cddf9a8e75a7\"], \"d909ca7e-b1d9-f8f3-9b57-cddf9a8e75a7\": [\"33430f0f-ebfa-c3ec-f237-3e77efa03d0a\"], \"17c9c895-5a16-7443-bb81-f34b30b21548\": []}, \"nodeIds\": [\"3f107997-04cc-8733-60a9-a4bb62cebffc\", \"33430f0f-ebfa-c3ec-f237-3e77efa03d0a\", \"17c9c895-5a16-7443-bb81-f34b30b21548\", \"d909ca7e-b1d9-f8f3-9b57-cddf9a8e75a7\"], \"nodes\": [{\"properties\": {}, \"name\": \"Start\", \"children\": [{\"to\": \"d909ca7e-b1d9-f8f3-9b57-cddf9a8e75a7\"}], \"actionParametersFetched\": false, \"type\": \"start-widget\", \"id\": \"3f107997-04cc-8733-60a9-a4bb62cebffc\", \"actionParameters\": []}, {\"properties\": {}, \"name\": \"End\", \"children\": [], \"actionParametersFetched\": false, \"type\": \"end-widget\", \"id\": \"33430f0f-ebfa-c3ec-f237-3e77efa03d0a\", \"actionParameters\": []}, {\"properties\": {\"message\": \"Action failed, error message[${wf:errorMessage(wf:lastErrorNode())}]\"}, \"name\": \"Kill\", \"children\": [], \"actionParametersFetched\": false, \"type\": \"kill-widget\", \"id\": \"17c9c895-5a16-7443-bb81-f34b30b21548\", \"actionParameters\": []}, {\"properties\": {\"job_xml\": [], \"app_name\": \"MySpark\", \"spark_opts\": \"\", \"class\": \"org.apache.oozie.example.SparkFileCopy\", \"job_properties\": [], \"spark_arguments\": [{\"value\": \"/user/hue/oozie/workspaces/data/sonnets.txt\"}, {\"value\": \"sonnets.txt\"}], \"spark_master\": \"local[*]\", \"mode\": \"client\", \"prepares\": [], \"jars\": \"lib/oozie-examples.jar\", \"sla\": [{\"value\": false, \"key\": \"enabled\"}, {\"value\": \"${nominal_time}\", \"key\": \"nominal-time\"}, {\"value\": \"\", \"key\": \"should-start\"}, {\"value\": \"${30 * MINUTES}\", \"key\": \"should-end\"}, {\"value\": \"\", \"key\": \"max-duration\"}, {\"value\": \"\", \"key\": \"alert-events\"}, {\"value\": \"\", \"key\": \"alert-contact\"}, {\"value\": \"\", \"key\": \"notification-msg\"}, {\"value\": \"\", \"key\": \"upstream-apps\"}]}, \"name\": \"spark-d909\", \"children\": [{\"to\": \"33430f0f-ebfa-c3ec-f237-3e77efa03d0a\"}, {\"error\": \"17c9c895-5a16-7443-bb81-f34b30b21548\"}], \"actionParametersFetched\": false, \"type\": \"spark-widget\", \"id\": \"d909ca7e-b1d9-f8f3-9b57-cddf9a8e75a7\", \"actionParameters\": []}], \"id\": 16, \"nodeNamesMapping\": {\"33430f0f-ebfa-c3ec-f237-3e77efa03d0a\": \"End\", \"3f107997-04cc-8733-60a9-a4bb62cebffc\": \"Start\", \"d909ca7e-b1d9-f8f3-9b57-cddf9a8e75a7\": \"spark-d909\", \"17c9c895-5a16-7443-bb81-f34b30b21548\": \"Kill\"}, \"uuid\": \"2d667ab2-70f9-c2bf-0726-abe84fa7130d\"}}",
+    "name": "Spark Jar"
+  }
+}
+]
diff --git a/apps/oozie/src/oozie/management/commands/oozie_setup.py b/apps/oozie/src/oozie/management/commands/oozie_setup.py
index 4b109db..b9d15ab 100644
--- a/apps/oozie/src/oozie/management/commands/oozie_setup.py
+++ b/apps/oozie/src/oozie/management/commands/oozie_setup.py
@@ -19,6 +19,7 @@ import logging
 import os
 from lxml import etree
 
+from django.core import management
 from django.core.management.base import NoArgsCommand
 from django.utils.translation import ugettext as _
 
@@ -26,7 +27,7 @@ from hadoop import cluster
 
 from desktop.models import Document
 from liboozie.submittion import create_directories
-from oozie.conf import LOCAL_SAMPLE_DATA_DIR, LOCAL_SAMPLE_DIR, REMOTE_SAMPLE_DIR
+from oozie.conf import LOCAL_SAMPLE_DATA_DIR, LOCAL_SAMPLE_DIR, REMOTE_SAMPLE_DIR, ENABLE_V2
 from oozie.models import Workflow, Coordinator, Bundle
 from oozie.importlib.workflows import import_workflow_root
 from oozie.importlib.coordinators import import_coordinator_root
@@ -131,6 +132,11 @@ class Command(NoArgsCommand):
 
     # Load jobs
     LOG.info(_("Installing examples..."))
-    self.install_examples()
+
+    if ENABLE_V2.get():
+      self.fs.do_as_user(self.fs.DEFAULT_USER, self.fs.copyFromLocal, local_dir, remote_data_dir)
+      management.call_command('loaddata', 'initial_oozie_examples.json', verbosity=2)
+    else:
+      self.install_examples()
 
     Document.objects.sync()
diff --git a/apps/oozie/src/oozie/templates/editor2/common_workflow.mako b/apps/oozie/src/oozie/templates/editor2/common_workflow.mako
index 9211354..98f0e51 100644
--- a/apps/oozie/src/oozie/templates/editor2/common_workflow.mako
+++ b/apps/oozie/src/oozie/templates/editor2/common_workflow.mako
@@ -733,14 +733,12 @@
 
         <div class="row-fluid">
           <div class="span6">
-        <span data-bind="text: $root.workflow_properties.spark_master.label" style="display: inline-block"></span>
-        <input type="text" class="input-medium" data-bind="value: properties.spark_master, attr: { placeholder: $root.workflow_properties.spark_master.help_text }" />
-
+            <span data-bind="text: $root.workflow_properties.spark_master.label" style="display: inline-block"></span>
+            <input type="text" class="input-medium" data-bind="value: properties.spark_master, attr: { placeholder: $root.workflow_properties.spark_master.help_text }" />
           </div>
           <div class="span6">
-                 <span data-bind="text: $root.workflow_properties.mode.label" style="display: inline-block"></span>
-        <input type="text" class="input-medium" data-bind="value: properties.mode, attr: { placeholder: $root.workflow_properties.mode.help_text }" />
-
+            <span data-bind="text: $root.workflow_properties.mode.label" style="display: inline-block"></span>
+            <input type="text" class="input-medium" data-bind="value: properties.mode, attr: { placeholder: $root.workflow_properties.mode.help_text }" />
           </div>
         </div>
 
@@ -758,20 +756,21 @@
         <input type="text" class="filechooser-input" data-bind="filechooser: properties.jars, filechooserOptions: globalFilechooserOptions, hdfsAutocomplete: properties.jars, attr: { placeholder:  $root.workflow_properties.jars.help_text }" />
         <span data-bind='template: { name: "common-fs-link", data: {path: properties.jars(), with_label: false}}'></span>
 
-  <h6>
-    <a class="pointer" data-bind="click: function(){ properties.spark_arguments.push({'value': ''}); $(document).trigger('drawArrows') }">
-      ${ _('Arguments') } <i class="fa fa-plus"></i>
-    </a>
-  </h6>
-  <ul class="unstyled" data-bind="visible: properties.spark_arguments().length > 0, foreach: properties.spark_arguments">
-    <li>
-      <input type="text" class="input-xlarge" data-bind="value: value, attr: { placeholder: $root.workflow_properties.spark_arguments.help_text }"/>
-      <a href="#" data-bind="click: function(){ $parent.properties.spark_arguments.remove(this); $(document).trigger('drawArrows') }">
-        <i class="fa fa-minus"></i>
-      </a>
-    </li>
-  </ul>
-  <em data-bind="visible: properties.spark_arguments().length == 0">${ _('No arguments defined.') }</em>
+        <h6>
+          <a class="pointer" data-bind="click: function(){ properties.spark_arguments.push({'value': ''}); $(document).trigger('drawArrows') }">
+            ${ _('Arguments') } <i class="fa fa-plus"></i>
+          </a>
+        </h6>
+        <ul class="unstyled" data-bind="visible: properties.spark_arguments().length > 0, foreach: properties.spark_arguments">
+          <li>
+            <input type="text" class="input-xlarge filechooser-input" data-bind="filechooser: value, filechooserOptions: globalFilechooserOptions, hdfsAutocomplete: value, attr: { placeholder:  $root.workflow_properties.spark_arguments.help_text }" />
+            <span data-bind='template: { name: "common-fs-link", data: {path: value, with_label: false}}'></span>
+            <a href="#" data-bind="click: function(){ $parent.properties.spark_arguments.remove(this); $(document).trigger('drawArrows') }">
+              <i class="fa fa-minus"></i>
+            </a>
+          </li>
+       </ul>
+       <em data-bind="visible: properties.spark_arguments().length == 0">${ _('No arguments defined.') }</em>
       </div>
     </div>
 
diff --git a/desktop/core/src/desktop/models.py b/desktop/core/src/desktop/models.py
index 93a99f8..9b6ee17 100644
--- a/desktop/core/src/desktop/models.py
+++ b/desktop/core/src/desktop/models.py
@@ -338,6 +338,10 @@ class DocumentManager(models.Manager):
             else:
               extra = ''
             doc = Document.objects.link(job, owner=job.owner, name=job.name, description=job.description, extra=extra)
+          if job.owner.username == SAMPLE_USERNAME:
+            job.doc.get().share_to_default()
+            tag = DocumentTag.objects.get_example_tag(user=job.owner)
+            doc.tags.add(tag)
     except Exception, e:
       LOG.warn(force_unicode(e))
 
-- 
1.7.9.5

