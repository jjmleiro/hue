From 3daacdbf8e0e432ea40ed55fcbf2bed749d424cc Mon Sep 17 00:00:00 2001
From: Erick Tryzelaar <erickt@cloudera.com>
Date: Mon, 26 Jan 2015 10:04:22 +0800
Subject: [PATCH 0671/1173] [spark] Update check_status to work with livy (not
 quite working yet)

---
 apps/spark/src/spark/models.py |   11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

diff --git a/apps/spark/src/spark/models.py b/apps/spark/src/spark/models.py
index 213418e..69bb23e 100644
--- a/apps/spark/src/spark/models.py
+++ b/apps/spark/src/spark/models.py
@@ -268,7 +268,7 @@ class SparkApi():
     try:
       return {
           'id': response['id'],
-          'has_result_set': True,
+          'has_result_set': response['state'] != 'running',
       }
     except Exception, e:
       message = force_unicode(str(e))
@@ -278,8 +278,15 @@ class SparkApi():
         raise e
 
   def check_status(self, notebook, snippet):
+    api = get_spark_api(self.user)
+    session = _get_snippet_session(notebook, snippet)
+    cell = snippet['result']['handle']['id']
+    response = api.fetch_data(session['id'], cell)
+
     try:
-      return {'status': 'available'}
+      return {
+          'status': response['state'],
+      }
     except Exception, e:
       message = force_unicode(str(e))
       if 'session not found' in message:
-- 
1.7.9.5

